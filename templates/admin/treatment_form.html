{% extends "base.html" %}

{% block title %}{{ action }} Treatment - Admin Panel{% endblock %}

{% block head %}
<!-- Include SortableJS for drag and drop functionality -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
<style>

    
    /* Better radio button styling */
    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .form-check-label {
        cursor: pointer;
        font-weight: 500;
    }
    
    .form-check-label:hover {
        color: #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-procedures"></i> {{ action }} Treatment</h2>
    <a href="/admin/treatments" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Treatments
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Treatment Information</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="/admin/treatments{% if treatment %}/{{ treatment.id }}{% endif %}" enctype="multipart/form-data">
                    <!-- Hidden fields for image management -->
                    <input type="hidden" id="image_order" name="image_order" value="">
                    <input type="hidden" name="update_image_order" value="">
                    <input type="hidden" name="delete_image_id" value="">
                    <input type="hidden" name="set_primary_image" value="">
                    
                    <!-- Basic Information -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Treatment Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   value="{{ treatment.name if treatment else '' }}" required
                                   placeholder="Cardiac Bypass Surgery">
                            <div class="form-text">Full treatment name</div>
                        </div>
                        <div class="col-md-6">
                            <label for="treatment_type" class="form-label">Treatment Type <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <select class="form-select" id="treatment_type" name="treatment_type" required>
                                    <option value="">Select Type</option>
                                    {% for type in treatment_types %}
                                    <option value="{{ type }}" {% if treatment and treatment.treatment_type == type %}selected{% endif %}>{{ type }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-success" onclick="showNewTypeModal()" title="Add New Type">
                                    <i class="fas fa-plus"></i>
                                </button>
                                {% if treatment %}
                                <button type="button" class="btn btn-outline-primary" onclick="showRenameTypeModal()" title="Rename Selected Type">
                                    <i class="fas fa-edit"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Short Description -->
                    <div class="mb-3">
                        <label for="short_description" class="form-label">Short Description <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="short_description" name="short_description" rows="3" required 
                                  maxlength="200" placeholder="Brief summary of the treatment">{{ treatment.short_description if treatment else '' }}</textarea>
                        <div class="form-text">0/200 characters - Brief summary for listings</div>
                    </div>

                    <!-- Long Description -->
                    <div class="mb-3">
                        <label for="long_description" class="form-label">Detailed Description</label>
                        <textarea class="form-control" id="long_description" name="long_description" rows="6" 
                                  placeholder="Detailed description of the treatment, procedure, benefits, risks, etc.">{{ treatment.long_description if treatment else '' }}</textarea>
                        <div class="form-text">Comprehensive treatment information</div>
                    </div>

                    <!-- Location -->
                    <div class="mb-3">
                        <label for="location" class="form-label">Location <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="location" name="location" 
                               value="{{ treatment.location if treatment else '' }}" required
                               placeholder="Mumbai, India">
                        <div class="form-text">City and country where treatment is available</div>
                    </div>

                    <!-- Features -->
                    <div class="mb-3">
                        <label for="features" class="form-label">Treatment Features</label>
                        <textarea class="form-control" id="features" name="features" rows="3"
                                  placeholder="Advanced Equipment, Minimally Invasive, Quick Recovery, Day Care Procedure">{{ treatment.features if treatment else '' }}</textarea>
                        <div class="form-text">Enter treatment features separated by commas (e.g., Advanced Technology, Quick Recovery, Minimal Pain)</div>
                    </div>

                    <!-- Pricing -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="price_exact" class="form-label">Price (â‚¹) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="price_exact" name="price_exact" 
                                   value="{{ treatment.price_exact if treatment else '' }}" min="0" step="0.01"
                                   placeholder="Enter treatment price" required>
                            <div class="form-text">Enter the treatment price in Indian Rupees</div>
                        </div>
                    </div>

                    <!-- Rating -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="rating" class="form-label">Rating (1-5)</label>
                            <input type="number" class="form-control" id="rating" name="rating" 
                                   value="{{ treatment.rating if treatment else '' }}" min="1" max="5" step="0.1"
                                   placeholder="4.5">
                        </div>
                    </div>

                    <!-- Hospital and Doctor -->
                    <h5 class="mb-3 text-primary">
                        <i class="fas fa-hospital"></i> Associated Hospital & Doctor
                    </h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="hospital_id" class="form-label">Hospital</label>
                            <select class="form-select" id="hospital_id" name="hospital_id">
                                <option value="">Select Hospital</option>
                                {% for hospital in hospitals %}
                                <option value="{{ hospital.id }}" {% if treatment and treatment.hospital_id == hospital.id %}selected{% endif %}>
                                    {{ hospital.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="other_hospital_name" class="form-label">Or Enter Hospital Name</label>
                            <input type="text" class="form-control" id="other_hospital_name" name="other_hospital_name" 
                                   value="{{ treatment.other_hospital_name if treatment else '' }}"
                                   placeholder="Hospital name if not in list">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="doctor_id" class="form-label">Doctor</label>
                            <select class="form-select" id="doctor_id" name="doctor_id">
                                <option value="">Select Doctor</option>
                                {% for doctor in doctors %}
                                <option value="{{ doctor.id }}" {% if treatment and treatment.doctor_id == doctor.id %}selected{% endif %}>
                                    {{ doctor.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="other_doctor_name" class="form-label">Or Enter Doctor Name</label>
                            <input type="text" class="form-control" id="other_doctor_name" name="other_doctor_name" 
                                   value="{{ treatment.other_doctor_name if treatment else '' }}"
                                   placeholder="Doctor name if not in list">
                        </div>
                    </div>

                    <!-- Images & Media -->
                    <h5 class="mb-3 text-primary">
                        <i class="fas fa-images"></i> Treatment Images
                    </h5>
                    
                    <div class="mb-3">
                        <label for="images" class="form-label">Upload Images</label>
                        <input type="file" class="form-control" id="images" name="images" multiple accept="image/*">
                        <div class="form-text">Upload procedure images, before/after photos, equipment images, etc.</div>
                    </div>

                    {% if treatment and treatment_images %}
                    <div class="mb-3">
                        <label class="form-label">Current Images (Drag to reorder)</label>
                        <div id="imageGallery" class="row g-2">
                            {% for image in treatment_images %}
                            <div class="col-md-3 image-item" data-image-id="{{ image.id }}" data-position="{{ image.position }}">
                                <div class="position-relative">
                                    <img src="{{ image.url }}" alt="Treatment Image" 
                                         class="img-thumbnail" 
                                         style="width: 100%; height: 120px; object-fit: cover; cursor: move;">
                                    
                                    <!-- Delete button -->
                                    <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 delete-image" 
                                            data-image-id="{{ image.id }}"
                                            onclick="deleteImageById('{{ image.id }}')"
                                            style="transform: translate(50%, -50%);">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    
                                    <!-- Primary image radio -->
                                    <div class="position-absolute top-0 start-0 p-1">
                                        <input type="radio" class="form-check-input set-primary" 
                                               name="primary_image" 
                                               value="{{ image.id }}" 
                                               {% if image.is_primary %}checked{% endif %}
                                               title="Set as primary image">
                                    </div>
                                    
                                    <!-- Position indicator -->
                                    <div class="position-absolute bottom-0 start-0 bg-dark text-white px-2 py-1 small">
                                        Position: <span class="position-number">{{ image.position or loop.index }}</span>
                                    </div>
                                    
                                    <!-- Primary indicator -->
                                    {% if image.is_primary %}
                                    <div class="position-absolute bottom-0 end-0 bg-warning text-dark px-2 py-1 small">
                                        <i class="fas fa-star"></i> Primary
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                    </div>
                    {% endif %}

                    <!-- Featured Treatment -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0"><i class="fas fa-star"></i> Featured Settings</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_featured" id="is_featured" value="true" 
                                       {% if treatment and treatment.is_featured %}checked{% endif %}>
                                <label class="form-check-label" for="is_featured">
                                    <i class="fas fa-star text-warning"></i> Featured Treatment
                                </label>
                                <div class="form-text">Featured treatments will be highlighted and shown prominently on the homepage.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Ayushman Bharat Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0"><i class="fas fa-file-medical"></i> Ayushman Bharat Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" name="is_ayushman" id="is_ayushman" value="true" 
                                       {% if treatment and treatment.is_ayushman %}checked{% endif %}>
                                <label class="form-check-label" for="is_ayushman">
                                    <i class="fas fa-check-circle text-success"></i> Covered under Ayushman Bharat
                                </label>
                                <div class="form-text">Check if this treatment is covered under the Ayushman Bharat scheme.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Treatment Benefits -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0"><i class="fas fa-check-circle"></i> Treatment Included & Excluded</h6>
                        </div>
                        <div class="card-body">
                            
                            <div class="mb-3">
                                <label for="Includes" class="form-label">What is Included</label>
                                <textarea class="form-control" id="Includes" name="Includes" rows="3"
                                          placeholder="List what is included in this treatment under Ayushman Bharat">{{ treatment.Includes if treatment else '' }}</textarea>
                                <div class="form-text">Describe what services, procedures, or items are covered for this treatment.</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="excludes" class="form-label">What is Excluded</label>
                                <textarea class="form-control" id="excludes" name="excludes" rows="3"
                                          placeholder="List what is excluded from this treatment under Ayushman Bharat">{{ treatment.excludes if treatment else '' }}</textarea>
                                <div class="form-text">Describe what services, procedures, or items are NOT covered for this treatment.</div>
                            </div>
                        </div>
                    </div>

                    <!-- FAQ Management -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0"><i class="fas fa-question-circle"></i> Frequently Asked Questions</h6>
                        </div>
                        <div class="card-body">
                            <!-- FAQ 1 -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 1 - Question:</label>
                                    <input type="text" class="form-control" name="faq1_question" 
                                           value="{{ treatment.faq1_question or '' }}" placeholder="Enter question 1">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 1 - Answer:</label>
                                    <textarea class="form-control" name="faq1_answer" rows="2" 
                                              placeholder="Enter answer 1">{{ treatment.faq1_answer or '' }}</textarea>
                                </div>
                            </div>
                            
                            <!-- FAQ 2 -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 2 - Question:</label>
                                    <input type="text" class="form-control" name="faq2_question" 
                                           value="{{ treatment.faq2_question or '' }}" placeholder="Enter question 2">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 2 - Answer:</label>
                                    <textarea class="form-control" name="faq2_answer" rows="2" 
                                              placeholder="Enter answer 2">{{ treatment.faq2_answer or '' }}</textarea>
                                </div>
                            </div>
                            
                            <!-- FAQ 3 -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 3 - Question:</label>
                                    <input type="text" class="form-control" name="faq3_question" 
                                           value="{{ treatment.faq3_question or '' }}" placeholder="Enter question 3">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 3 - Answer:</label>
                                    <textarea class="form-control" name="faq3_answer" rows="2" 
                                              placeholder="Enter answer 3">{{ treatment.faq3_answer or '' }}</textarea>
                                </div>
                            </div>
                            
                            <!-- FAQ 4 -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 4 - Question:</label>
                                    <input type="text" class="form-control" name="faq4_question" 
                                           value="{{ treatment.faq4_question or '' }}" placeholder="Enter question 4">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 4 - Answer:</label>
                                    <textarea class="form-control" name="faq4_answer" rows="2" 
                                              placeholder="Enter answer 4">{{ treatment.faq4_answer or '' }}</textarea>
                                </div>
                            </div>
                            
                            <!-- FAQ 5 -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 5 - Question:</label>
                                    <input type="text" class="form-control" name="faq5_question" 
                                           value="{{ treatment.faq5_question or '' }}" placeholder="Enter question 5">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 5 - Answer:</label>
                                    <textarea class="form-control" name="faq5_answer" rows="2" 
                                              placeholder="Enter answer 5">{{ treatment.faq5_answer or '' }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-flex justify-content-between">
                        <a href="/admin/treatments" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> {{ action }} Treatment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="fas fa-info-circle"></i> Help &amp; Guidelines</h6>
            </div>
            <div class="card-body">
                <h6>Required Fields</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-check text-success"></i> Treatment Name</li>
                    <li><i class="fas fa-check text-success"></i> Treatment Type</li>
                    <li><i class="fas fa-check text-success"></i> Short Description</li>
                    <li><i class="fas fa-check text-success"></i> Location</li>
                    <li><i class="fas fa-check text-success"></i> Price</li>
                </ul>

                <h6 class="mt-3">Pricing Guidelines</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-info text-info"></i> Enter the treatment price in Indian Rupees</li>
                    <li><i class="fas fa-info text-info"></i> Include all associated costs</li>
                    <li><i class="fas fa-info text-info"></i> Update prices regularly</li>
                    <li><i class="fas fa-info text-info"></i> Use competitive and fair pricing</li>
                </ul>

                <h6 class="mt-3">Content Tips</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-lightbulb text-warning"></i> Use clear, medical terminology</li>
                    <li><i class="fas fa-lightbulb text-warning"></i> Include benefits and risks</li>
                    <li><i class="fas fa-lightbulb text-warning"></i> Mention recovery time</li>
                    <li><i class="fas fa-lightbulb text-warning"></i> Add pre/post procedure care</li>
                </ul>

                <h6 class="mt-3">Features Guidelines</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-star text-success"></i> Separate features with commas</li>
                    <li><i class="fas fa-star text-success"></i> Use descriptive terms</li>
                    <li><i class="fas fa-star text-success"></i> Example: Advanced Equipment, Quick Recovery</li>
                    <li><i class="fas fa-star text-success"></i> Keep features concise and relevant</li>
                </ul>

                <h6 class="mt-3">Image Guidelines</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-camera text-info"></i> Professional medical images</li>
                    <li><i class="fas fa-camera text-info"></i> Before/after comparisons</li>
                    <li><i class="fas fa-camera text-info"></i> Equipment and facility photos</li>
                    <li><i class="fas fa-camera text-info"></i> Maintain patient privacy</li>
                </ul>
            </div>
        </div>

        <!-- Treatment Types Info -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="fas fa-list"></i> Treatment Types</h6>
            </div>
            <div class="card-body">
                <small class="text-muted">
                    <strong>Surgery:</strong> Operative procedures<br>
                    <strong>Medical:</strong> Non-surgical treatments<br>
                    <strong>Diagnostic:</strong> Tests and examinations<br>
                    <strong>Therapy:</strong> Rehabilitation services<br>
                    <strong>Preventive:</strong> Health maintenance<br>
                    <strong>Cosmetic:</strong> Aesthetic procedures<br>
                    <strong>Emergency:</strong> Urgent care
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Treatment Type Modals -->
<div class="modal fade" id="newTypeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Treatment Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newTypeForm">
                    <div class="mb-3">
                        <label for="newTypeName" class="form-label">Treatment Type Name</label>
                        <input type="text" class="form-control" id="newTypeName" 
                               placeholder="e.g., Orthopedic Surgery">
                        <div class="form-text">Enter a unique treatment type name</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addNewType()">Add Type</button>
            </div>
        </div>
    </div>
</div>

<!-- Rename Treatment Type Modal -->
<div class="modal fade" id="renameTypeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rename Treatment Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="renameTypeForm">
                    <div class="mb-3">
                        <label for="currentTypeName" class="form-label">Current Treatment Type</label>
                        <input type="text" class="form-control" id="currentTypeName" readonly
                               value="{{ treatment.treatment_type if treatment else '' }}">
                        <div class="form-text">Current selected treatment type</div>
                    </div>
                    <div class="mb-3">
                        <label for="renameTypeName" class="form-label">New Treatment Type Name</label>
                        <input type="text" class="form-control" id="renameTypeName" 
                               value="{{ treatment.treatment_type if treatment else '' }}"
                               placeholder="Enter new treatment type name">
                        <div class="form-text">Enter the new name for this treatment type</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="renameTreatmentType()">
                    <i class="fas fa-save"></i> Rename Type
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
const TREATMENT_ID = {% if treatment and treatment.id %}{{ treatment.id }}{% else %}null{% endif %};
console.log('TREATMENT_ID initialized:', TREATMENT_ID, typeof TREATMENT_ID);

// Simple global functions
function deleteImageById(imageId) {
    if (!confirm('Delete this image?')) return;
    
    const form = document.querySelector('form');
    const formData = new FormData(form);
    formData.append('delete_image_id', imageId);
    
    fetch(window.location.href.replace('/edit', ''), {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Simple reload to refresh the page
        } else {
            alert('Failed to delete image');
        }
    })
    .catch(error => {
        alert('Error deleting image');
    });
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    const imageGallery = document.getElementById('imageGallery');
    if (!imageGallery) return;
    
    // Simple drag and drop
    new Sortable(imageGallery, {
        animation: 150,
        onEnd: function() {
            // Get new order
            const items = imageGallery.querySelectorAll('.image-item');
            const imageOrder = [];
            
            items.forEach((item, index) => {
                const imageId = item.getAttribute('data-image-id');
                if (imageId) {
                    imageOrder.push({
                        id: parseInt(imageId),
                        position: index + 1
                    });
                }
            });
            
            // Save order
            const form = document.querySelector('form');
            const formData = new FormData(form);
            formData.append('update_image_order', 'true');
            formData.append('image_order', JSON.stringify(imageOrder));
            
            fetch(window.location.href.replace('/edit', ''), {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Reload to show updated positions
                }
            })
            .catch(error => console.error('Error saving order:', error));
        }
    });



    // Character count for short description
    const shortDescInput = document.getElementById('short_description');
    if (shortDescInput) {
        shortDescInput.addEventListener('input', function() {
            const length = this.value.length;
            const helpText = this.nextElementSibling;
            helpText.textContent = `${length}/200 characters - Brief summary for listings`;
            
            if (length > 200) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }
});

// Treatment Type Management Functions
function showNewTypeModal() {
    document.getElementById('newTypeName').value = '';
    new bootstrap.Modal(document.getElementById('newTypeModal')).show();
}

async function addNewType() {
    const typeName = document.getElementById('newTypeName').value.trim();
    
    if (!typeName) {
        alert('Please enter a treatment type name.');
        return;
    }
    
    // Check if type already exists in current dropdown
    const select = document.getElementById('treatment_type');
    const existingOptions = Array.from(select.options).map(option => option.value.toLowerCase());
    
    if (existingOptions.includes(typeName.toLowerCase())) {
        alert('This treatment type already exists in the current list.');
        return;
    }
    
    // Add new option to select
    const newOption = document.createElement('option');
    newOption.value = typeName;
    newOption.textContent = typeName;
    newOption.selected = true;
    
    // Insert in alphabetical order
    const options = Array.from(select.options).slice(1); // Skip the first "Select Type" option
    let inserted = false;
    
    for (let i = 0; i < options.length; i++) {
        if (typeName.toLowerCase() < options[i].value.toLowerCase()) {
            select.insertBefore(newOption, options[i]);
            inserted = true;
            break;
        }
    }
    
    if (!inserted) {
        select.appendChild(newOption);
    }
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('newTypeModal')).hide();
    
    // Show success message
    showSuccessMessage(`New treatment type "${typeName}" has been added locally. It will be saved when you submit the form.`);
}

function showSuccessMessage(message) {
    const successMsg = document.createElement('div');
    successMsg.className = 'alert alert-success alert-dismissible fade show mt-2';
    successMsg.innerHTML = `
        <strong>Success!</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert after the treatment type field
    const treatmentTypeDiv = document.getElementById('treatment_type')?.closest('.col-md-6');
    if (treatmentTypeDiv) {
        treatmentTypeDiv.appendChild(successMsg);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            if (successMsg && successMsg.parentNode) {
                successMsg.remove();
            }
        }, 5000);
    }
}

// Treatment Type Rename Functions
function showRenameTypeModal() {
    const treatmentTypeSelect = document.getElementById('treatment_type');
    const currentType = treatmentTypeSelect.value;
    const currentTypeText = treatmentTypeSelect.options[treatmentTypeSelect.selectedIndex].text;
    
    if (!currentType) {
        alert('Please select a treatment type first.');
        return;
    }
    
    document.getElementById('currentTypeName').value = currentTypeText;
    document.getElementById('renameTypeName').value = ''; // Clear the input field
    document.getElementById('renameTypeName').placeholder = `Enter new name for "${currentTypeText}"`;
    new bootstrap.Modal(document.getElementById('renameTypeModal')).show();
    
    // Focus on the input field
    setTimeout(() => {
        document.getElementById('renameTypeName').focus();
    }, 500);
}

function renameTreatmentType() {
    console.log('renameTreatmentType called');
    
    const newTypeName = document.getElementById('renameTypeName').value.trim();
    const treatmentTypeSelect = document.getElementById('treatment_type');
    const currentType = treatmentTypeSelect.value;
    const currentTypeText = treatmentTypeSelect.options[treatmentTypeSelect.selectedIndex].text;
    
    console.log('Current type:', currentTypeText);
    console.log('New type name:', newTypeName);
    
    // If empty input, just close modal without doing anything
    if (!newTypeName) {
        console.log('Empty input, closing modal');
        bootstrap.Modal.getInstance(document.getElementById('renameTypeModal')).hide();
        return;
    }
    
    if (newTypeName === currentTypeText) {
        alert(`The new type name "${newTypeName}" is the same as the current type name. Please enter a different name.`);
        return;
    }
    
    // Check if the new type name already exists in the dropdown
    const existingOptions = Array.from(treatmentTypeSelect.options).map(option => option.text.toLowerCase());
    if (existingOptions.includes(newTypeName.toLowerCase())) {
        alert('This treatment type name already exists in the list.');
        return;
    }
    
    console.log('Updating option text and value');
    
    // Update the selected option text
    const selectedOption = treatmentTypeSelect.options[treatmentTypeSelect.selectedIndex];
    selectedOption.text = newTypeName;
    selectedOption.value = newTypeName;
    
    console.log('Updated option:', selectedOption.text, selectedOption.value);
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('renameTypeModal')).hide();
    
    // Show success message
    showRenameSuccessMessage(`Treatment type updated from "${currentTypeText}" to "${newTypeName}". Remember to save the form to persist changes.`);
}

function showRenameSuccessMessage(message) {
    const successMsg = document.createElement('div');
    successMsg.className = 'alert alert-info alert-dismissible fade show mt-2';
    successMsg.innerHTML = `
        <strong>Info!</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of the form
    const formContainer = document.querySelector('.card-body');
    if (formContainer) {
        formContainer.insertBefore(successMsg, formContainer.firstChild);
        
        // Auto dismiss after 8 seconds
        setTimeout(() => {
            if (successMsg && successMsg.parentNode) {
                successMsg.remove();
            }
        }, 8000);
    }
}

// Simple FAQ Management Functions
function addFAQRow() {
    console.log('addFAQRow called');
    const faqHtml = `
        <div class="faq-row border rounded p-3 mb-3">
            <input type="hidden" name="faq_ids[]" value="">
            <div class="row mb-2">
                <div class="col-md-12">
                    <label class="form-label fw-bold">Question:</label>
                    <input type="text" class="form-control" name="faq_questions[]" 
                           placeholder="Enter the question">
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-md-12">
                    <label class="form-label fw-bold">Answer:</label>
                    <textarea class="form-control" name="faq_answers[]" rows="3" 
                              placeholder="Enter the answer"></textarea>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Position:</label>
                    <input type="number" class="form-control" name="faq_positions[]" 
                           value="0" min="0">
                </div>
                <div class="col-md-6 d-flex align-items-end justify-content-between">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="faq_active[]" 
                               value="1" checked>
                        <label class="form-check-label">Active</label>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeFAQRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Hide no-faqs message if it exists
    const noFaqsMessage = document.getElementById('no-faqs-message');
    if (noFaqsMessage) {
        noFaqsMessage.style.display = 'none';
    }
    
    // Add the new FAQ row
    document.getElementById('faq-container').insertAdjacentHTML('beforeend', faqHtml);
}

function removeFAQRow(button) {
    const faqRow = button.closest('.faq-row');
    faqRow.remove();
    
    // Show no-faqs message if no FAQs left
    const remainingFaqs = document.querySelectorAll('.faq-row').length;
    if (remainingFaqs === 0) {
        const noFaqsMessage = document.getElementById('no-faqs-message');
        if (noFaqsMessage) {
            noFaqsMessage.style.display = 'block';
        }
    }
}
</script>
{% endblock %}
