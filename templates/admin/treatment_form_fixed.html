{% extends "base.html" %}

{% block title %}{{ action }} Treatment - Admin Panel{% endblock %}

{% block head %}
<!-- Include SortableJS for drag and drop functionality -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-procedures"></i> {{ action }} Treatment</h2>
    <a href="/admin/treatments" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Treatments
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Treatment Information</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="/admin/treatments{% if treatment %}/{{ treatment.id }}{% endif %}" enctype="multipart/form-data">
                    <!-- Hidden fields for image management -->
                    <input type="hidden" name="faq_questions[]" value="">
                    <input type="hidden" name="faq_answers[]" value="">
                    <input type="hidden" id="image_order" name="image_order" value="">
                    <input type="hidden" name="update_image_order" value="">
                    <input type="hidden" name="delete_image_id" value="">
                    <input type="hidden" name="set_primary_image" value="">
                    
                    <!-- Basic Information -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Treatment Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   value="{{ treatment.name if treatment else '' }}" required
                                   placeholder="Cardiac Bypass Surgery">
                            <div class="form-text">Full treatment name</div>
                        </div>
                        <div class="col-md-6">
                            <label for="treatment_type" class="form-label">Treatment Type <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <select class="form-select" id="treatment_type" name="treatment_type" required>
                                    <option value="">Select Type</option>
                                    {% for type in treatment_types %}
                                    <option value="{{ type }}" {% if treatment and treatment.treatment_type == type %}selected{% endif %}>{{ type }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-success" onclick="showNewTypeModal()" title="Add New Type">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Short Description -->
                    <div class="mb-3">
                        <label for="short_description" class="form-label">Short Description <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="short_description" name="short_description" rows="3" required 
                                  maxlength="200" placeholder="Brief summary of the treatment">{{ treatment.short_description if treatment else '' }}</textarea>
                        <div class="form-text">0/200 characters - Brief summary for listings</div>
                    </div>

                    <!-- Long Description -->
                    <div class="mb-3">
                        <label for="long_description" class="form-label">Detailed Description</label>
                        <textarea class="form-control" id="long_description" name="long_description" rows="6" 
                                  placeholder="Detailed description of the treatment, procedure, benefits, risks, etc.">{{ treatment.long_description if treatment else '' }}</textarea>
                        <div class="form-text">Comprehensive treatment information</div>
                    </div>

                    <!-- Location -->
                    <div class="mb-3">
                        <label for="location" class="form-label">Location <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="location" name="location" 
                               value="{{ treatment.location if treatment else '' }}" required
                               placeholder="Mumbai, India">
                        <div class="form-text">City and country where treatment is available</div>
                    </div>

                    <!-- Pricing -->
                    <h5 class="mb-3 text-primary">
                        <i class="fas fa-dollar-sign"></i> Pricing Information
                    </h5>
                    
                    <div class="mb-3">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="price_type" id="price_range" value="range" 
                                   {% if not treatment or (treatment.price_min and treatment.price_max) %}checked{% endif %}>
                            <label class="form-check-label" for="price_range">Price Range</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="price_type" id="price_exact_radio" value="exact"
                                   {% if treatment and treatment.price_exact %}checked{% endif %}>
                            <label class="form-check-label" for="price_exact_radio">Exact Price</label>
                        </div>
                    </div>

                    <div class="row mb-3" id="price_range_fields">
                        <div class="col-md-6">
                            <label for="price_min" class="form-label">Minimum Price ($)</label>
                            <input type="number" class="form-control" id="price_min" name="price_min" 
                                   value="{{ treatment.price_min if treatment else '' }}" min="0" step="0.01"
                                   placeholder="1000.00">
                        </div>
                        <div class="col-md-6">
                            <label for="price_max" class="form-label">Maximum Price ($)</label>
                            <input type="number" class="form-control" id="price_max" name="price_max" 
                                   value="{{ treatment.price_max if treatment else '' }}" min="0" step="0.01"
                                   placeholder="5000.00">
                        </div>
                    </div>

                    <div class="row mb-3" id="price_exact_field">
                        <div class="col-md-6">
                            <label for="price_exact" class="form-label">Exact Price ($)</label>
                            <input type="number" class="form-control" id="price_exact" name="price_exact" 
                                   value="{{ treatment.price_exact if treatment else '' }}" min="0" step="0.01"
                                   placeholder="2500.00">
                        </div>
                    </div>

                    <!-- Rating -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="rating" class="form-label">Rating (1-5)</label>
                            <input type="number" class="form-control" id="rating" name="rating" 
                                   value="{{ treatment.rating if treatment else '' }}" min="1" max="5" step="0.1"
                                   placeholder="4.5">
                        </div>
                    </div>

                    <!-- Hospital and Doctor -->
                    <h5 class="mb-3 text-primary">
                        <i class="fas fa-hospital"></i> Associated Hospital & Doctor
                    </h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="hospital_id" class="form-label">Hospital</label>
                            <select class="form-select" id="hospital_id" name="hospital_id">
                                <option value="">Select Hospital</option>
                                {% for hospital in hospitals %}
                                <option value="{{ hospital.id }}" {% if treatment and treatment.hospital_id == hospital.id %}selected{% endif %}>
                                    {{ hospital.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="other_hospital_name" class="form-label">Or Enter Hospital Name</label>
                            <input type="text" class="form-control" id="other_hospital_name" name="other_hospital_name" 
                                   value="{{ treatment.other_hospital_name if treatment else '' }}"
                                   placeholder="Hospital name if not in list">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="doctor_id" class="form-label">Doctor</label>
                            <select class="form-select" id="doctor_id" name="doctor_id">
                                <option value="">Select Doctor</option>
                                {% for doctor in doctors %}
                                <option value="{{ doctor.id }}" {% if treatment and treatment.doctor_id == doctor.id %}selected{% endif %}>
                                    {{ doctor.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="other_doctor_name" class="form-label">Or Enter Doctor Name</label>
                            <input type="text" class="form-control" id="other_doctor_name" name="other_doctor_name" 
                                   value="{{ treatment.other_doctor_name if treatment else '' }}"
                                   placeholder="Doctor name if not in list">
                        </div>
                    </div>

                    <!-- Images & Media -->
                    <h5 class="mb-3 text-primary">
                        <i class="fas fa-images"></i> Treatment Images
                    </h5>
                    
                    <div class="mb-3">
                        <label for="images" class="form-label">Upload Images</label>
                        <input type="file" class="form-control" id="images" name="images" multiple accept="image/*">
                        <div class="form-text">Upload procedure images, before/after photos, equipment images, etc.</div>
                    </div>

                    {% if treatment and treatment_images %}
                    <div class="mb-3">
                        <label class="form-label">Current Images (Drag to reorder)</label>
                        <div id="imageGallery" class="row g-2">
                            {% for image in treatment_images %}
                            <div class="col-md-3 image-item" data-image-id="{{ image.id }}" data-position="{{ image.position }}">
                                <div class="position-relative">
                                    <img src="{{ image.url }}" alt="Treatment Image" 
                                         class="img-thumbnail" 
                                         style="width: 100%; height: 120px; object-fit: cover; cursor: move;">
                                    
                                    <!-- Delete button -->
                                    <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 delete-image" 
                                            data-image-id="{{ image.id }}"
                                            style="transform: translate(50%, -50%);">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    
                                    <!-- Primary image radio -->
                                    <div class="position-absolute top-0 start-0 p-1">
                                        <input type="radio" class="form-check-input set-primary" 
                                               name="primary_image" 
                                               value="{{ image.id }}" 
                                               {% if image.is_primary %}checked{% endif %}
                                               title="Set as primary image">
                                    </div>
                                    
                                    <!-- Position indicator -->
                                    <div class="position-absolute bottom-0 start-0 bg-dark text-white px-2 py-1 small">
                                        Position: <span class="position-number">{{ image.position or loop.index }}</span>
                                    </div>
                                    
                                    <!-- Primary indicator -->
                                    {% if image.is_primary %}
                                    <div class="position-absolute bottom-0 end-0 bg-warning text-dark px-2 py-1 small">
                                        <i class="fas fa-star"></i> Primary
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Save order button -->
                        <button type="button" id="saveImageOrder" class="btn btn-success mt-2" style="display: none;">
                            <i class="fas fa-save"></i> Save Order
                        </button>
                    </div>
                    {% endif %}

                    <!-- Featured Treatment -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0"><i class="fas fa-star"></i> Featured Settings</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_featured" id="is_featured" value="true" 
                                       {% if treatment and treatment.is_featured %}checked{% endif %}>
                                <label class="form-check-label" for="is_featured">
                                    <i class="fas fa-star text-warning"></i> Featured Treatment
                                </label>
                                <div class="form-text">Featured treatments will be highlighted and shown prominently on the homepage.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-flex justify-content-between">
                        <a href="/admin/treatments" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> {{ action }} Treatment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Treatment Type Modals -->
<div class="modal fade" id="newTypeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Treatment Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newTypeForm">
                    <div class="mb-3">
                        <label for="newTypeName" class="form-label">Treatment Type Name</label>
                        <input type="text" class="form-control" id="newTypeName" 
                               placeholder="e.g., Orthopedic Surgery">
                        <div class="form-text">Enter a unique treatment type name</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addNewType()">Add Type</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const imageGallery = document.getElementById('imageGallery');
    const saveImageOrderBtn = document.getElementById('saveImageOrder');
    
    if (imageGallery) {
        // Initialize SortableJS for drag and drop
        const sortable = new Sortable(imageGallery, {
            animation: 150,
            ghostClass: 'bg-light',
            onUpdate: function() {
                if (saveImageOrderBtn) {
                    saveImageOrderBtn.style.display = 'inline-block';
                }
                updatePositionNumbers();
            }
        });

        // Update position numbers after reordering
        function updatePositionNumbers() {
            const items = imageGallery.querySelectorAll('.image-item');
            items.forEach((item, index) => {
                const positionSpan = item.querySelector('.position-number');
                if (positionSpan) {
                    positionSpan.textContent = index + 1;
                }
            });
        }

        // Handle save order button click
        if (saveImageOrderBtn) {
            saveImageOrderBtn.addEventListener('click', function() {
                const imageOrder = [];
                const items = imageGallery.querySelectorAll('.image-item');
                items.forEach((item, index) => {
                    const imageId = item.getAttribute('data-image-id');
                    if (imageId) {
                        imageOrder.push({
                            id: parseInt(imageId),
                            position: index + 1
                        });
                    }
                });

                // Update hidden input with new order
                document.getElementById('image_order').value = JSON.stringify(imageOrder);

                // Submit the form to save the order
                const form = document.querySelector('form');
                const formData = new FormData(form);
                formData.append('update_image_order', 'true');

                fetch(form.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccessMessage('Image order updated successfully');
                        saveImageOrderBtn.style.display = 'none';
                    } else {
                        alert('Failed to update image order: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error updating image order:', error);
                    alert('Error updating image order. Please try again.');
                });
            });
        }

        // Handle delete image buttons
        document.querySelectorAll('.delete-image').forEach(button => {
            button.addEventListener('click', function() {
                const imageId = this.getAttribute('data-image-id');
                if (!confirm('Are you sure you want to delete this image? This action cannot be undone.')) {
                    return;
                }

                const form = document.querySelector('form');
                const formData = new FormData(form);
                formData.append('delete_image_id', imageId);

                fetch(form.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the image element from the DOM
                        const imageItem = document.querySelector(`.image-item[data-image-id="${imageId}"]`);
                        if (imageItem) {
                            imageItem.remove();
                            updatePositionNumbers();
                            showSuccessMessage('Image deleted successfully');
                        }
                    } else {
                        alert('Failed to delete image: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error deleting image:', error);
                    alert('Error deleting image. Please try again.');
                });
            });
        });

        // Handle set as primary image
        document.querySelectorAll('.set-primary').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    const imageId = this.value;
                    const form = document.querySelector('form');
                    const formData = new FormData(form);
                    formData.append('set_primary_image', imageId);

                    fetch(form.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showSuccessMessage('Primary image updated successfully');
                            // Update UI to show new primary image
                            location.reload();
                        } else {
                            alert('Failed to update primary image: ' + (data.message || 'Unknown error'));
                            this.checked = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error updating primary image:', error);
                        alert('Error updating primary image. Please try again.');
                        this.checked = false;
                    });
                }
            });
        });
    }

    // Price type toggle
    const priceRangeRadio = document.getElementById('price_range');
    const priceExactRadio = document.getElementById('price_exact_radio');
    const priceRangeFields = document.getElementById('price_range_fields');
    const priceExactField = document.getElementById('price_exact_field');

    function togglePriceFields() {
        if (priceRangeRadio && priceRangeRadio.checked) {
            priceRangeFields.style.display = 'flex';
            priceExactField.style.display = 'none';
            document.getElementById('price_exact').value = '';
        } else if (priceExactRadio && priceExactRadio.checked) {
            priceRangeFields.style.display = 'none';
            priceExactField.style.display = 'flex';
            document.getElementById('price_min').value = '';
            document.getElementById('price_max').value = '';
        }
    }

    if (priceRangeRadio) priceRangeRadio.addEventListener('change', togglePriceFields);
    if (priceExactRadio) priceExactRadio.addEventListener('change', togglePriceFields);
    
    // Initial toggle
    togglePriceFields();

    // Character count for short description
    const shortDescInput = document.getElementById('short_description');
    if (shortDescInput) {
        shortDescInput.addEventListener('input', function() {
            const length = this.value.length;
            const helpText = this.nextElementSibling;
            helpText.textContent = `${length}/200 characters - Brief summary for listings`;
            
            if (length > 200) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }
});

// Treatment Type Management Functions
function showNewTypeModal() {
    document.getElementById('newTypeName').value = '';
    new bootstrap.Modal(document.getElementById('newTypeModal')).show();
}

async function addNewType() {
    const typeName = document.getElementById('newTypeName').value.trim();
    
    if (!typeName) {
        alert('Please enter a treatment type name.');
        return;
    }
    
    // Check if type already exists in current dropdown
    const select = document.getElementById('treatment_type');
    const existingOptions = Array.from(select.options).map(option => option.value.toLowerCase());
    
    if (existingOptions.includes(typeName.toLowerCase())) {
        alert('This treatment type already exists in the current list.');
        return;
    }
    
    // Add new option to select
    const newOption = document.createElement('option');
    newOption.value = typeName;
    newOption.textContent = typeName;
    newOption.selected = true;
    
    // Insert in alphabetical order
    const options = Array.from(select.options).slice(1); // Skip the first "Select Type" option
    let inserted = false;
    
    for (let i = 0; i < options.length; i++) {
        if (typeName.toLowerCase() < options[i].value.toLowerCase()) {
            select.insertBefore(newOption, options[i]);
            inserted = true;
            break;
        }
    }
    
    if (!inserted) {
        select.appendChild(newOption);
    }
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('newTypeModal')).hide();
    
    // Show success message
    showSuccessMessage(`New treatment type "${typeName}" has been added locally. It will be saved when you submit the form.`);
}

function showSuccessMessage(message) {
    const successMsg = document.createElement('div');
    successMsg.className = 'alert alert-success alert-dismissible fade show mt-2';
    successMsg.innerHTML = `
        <strong>Success!</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert after the treatment type field
    const treatmentTypeDiv = document.getElementById('treatment_type')?.closest('.col-md-6');
    if (treatmentTypeDiv) {
        treatmentTypeDiv.appendChild(successMsg);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            if (successMsg && successMsg.parentNode) {
                successMsg.remove();
            }
        }, 5000);
    }
}
</script>
{% endblock %}
