{% extends "base.html" %}

{% block title %}{{ action }} Doctor - Admin Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-user-md"></i> {{ action }} Doctor</h2>
    <a href="/admin/doctors" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Doctors
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Doctor Information</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="/admin/doctors{% if doctor %}/{{ doctor.id }}{% endif %}" enctype="multipart/form-data">
                    <!-- Hidden fields to ensure FAQ arrays are always submitted -->
                    <input type="hidden" name="faq_questions[]" value="">
                    <input type="hidden" name="faq_answers[]" value="">
                    
                    <!-- Basic Information -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Doctor Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   value="{{ doctor.name if doctor else '' }}" required
                                   placeholder="Dr. John Smith">
                            <div class="form-text">Full name with title (Dr./Prof.)</div>
                        </div>
                        <div class="col-md-6">
                            <label for="designation" class="form-label">Designation <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="designation" name="designation" 
                                   value="{{ doctor.designation if doctor else '' }}" required
                                   placeholder="Senior Cardiologist">
                            <div class="form-text">Professional designation/title</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="hospital_id" class="form-label">Hospital <span class="text-danger">*</span></label>
                            <select class="form-select" id="hospital_id" name="hospital_id" required>
                                <option value="">Select Hospital</option>
                                {% for hospital in hospitals %}
                                <option value="{{ hospital.id }}" 
                                        {% if doctor and doctor.hospital_id == hospital.id %}selected{% endif %}>
                                    {{ hospital.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Primary hospital affiliation</div>
                        </div>
                        <div class="col-md-6">
                            <label for="location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="location" name="location" 
                                   value="{{ doctor.location if doctor else '' }}"
                                   placeholder="Indore, Madhya Pradesh">
                            <div class="form-text">City and state where doctor practices</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="experience_years" class="form-label">Experience (Years)</label>
                            <input type="number" class="form-control" id="experience_years" name="experience_years" 
                                   value="{{ doctor.experience_years if doctor else '' }}" min="0" max="50"
                                   placeholder="10">
                            <div class="form-text">Years of practice</div>
                        </div>
                        <div class="col-md-3">
                            <label for="gender" class="form-label">Gender</label>
                            <select class="form-select" id="gender" name="gender">
                                <option value="">Select Gender</option>
                                <option value="Male" {% if doctor and doctor.gender == 'Male' %}selected{% endif %}>Male</option>
                                <option value="Female" {% if doctor and doctor.gender == 'Female' %}selected{% endif %}>Female</option>
                                <option value="Other" {% if doctor and doctor.gender == 'Other' %}selected{% endif %}>Other</option>
                            </select>
                            <div class="form-text">Doctor's gender</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="rating" class="form-label">Rating</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="rating" name="rating" 
                                       value="{{ doctor.rating if doctor else '' }}" 
                                       min="1" max="5" step="0.1" 
                                       placeholder="4.5">
                                <span class="input-group-text">
                                    <i class="fas fa-star text-warning"></i>
                                </span>
                            </div>
                            <div class="form-text">Rating from 1.0 to 5.0 stars</div>
                        </div>
                        <div class="col-md-4">
                            <label for="consultancy_fee" class="form-label">Consultancy Fee</label>
                            <div class="input-group">
                                <span class="input-group-text">â‚¹</span>
                                <input type="number" class="form-control" id="consultancy_fee" name="consultancy_fee" 
                                       value="{{ doctor.consultancy_fee if doctor else '' }}" 
                                       min="0" step="50" 
                                       placeholder="500">
                            </div>
                            <div class="form-text">Consultation fee in rupees</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="short_description" class="form-label">Short Description <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="short_description" name="short_description" rows="2" required
                                  placeholder="Brief summary for cards and listings...">{{ doctor.short_description if doctor else '' }}</textarea>
                        <div class="form-text">Brief description for doctor cards and listings (max 500 chars)</div>
                    </div>

                    <div class="mb-3">
                        <label for="long_description" class="form-label">Long Description</label>
                        <textarea class="form-control" id="long_description" name="long_description" rows="4"
                                  placeholder="Detailed biography, expertise, approach to patient care, and professional background...">{{ doctor.long_description if doctor else '' }}</textarea>
                        <div class="form-text">Detailed description for doctor profile page</div>
                    </div>

                    <!-- Professional Details -->
                    <h5 class="mb-3 text-primary">
                        <i class="fas fa-graduation-cap"></i> Professional Details
                    </h5>
                    
                    <div class="mb-3">
                        <label for="specialization" class="form-label">Specialization</label>
                        <input type="text" class="form-control" id="specialization" name="specialization" 
                               value="{{ doctor.specialization if doctor else '' }}" 
                               placeholder="Interventional Cardiology">
                        <div class="form-text">Primary medical specialization</div>
                    </div>

                    <div class="mb-3">
                        <label for="skills" class="form-label">Skills & Expertise</label>
                        <textarea class="form-control" id="skills" name="skills" rows="3"
                                  placeholder="Heart Surgery, Angioplasty, Cardiac Catheterization, Echocardiography...">{{ doctor.skills if doctor and doctor.skills else '' }}</textarea>
                        <div class="form-text">List key skills and areas of expertise (comma-separated)</div>
                    </div>

                    <div class="mb-3">
                        <label for="qualifications" class="form-label">Qualifications</label>
                        <textarea class="form-control" id="qualifications" name="qualifications" rows="3"
                                  placeholder="MBBS, MD (Cardiology), DM (Interventional Cardiology), Fellowship in Cardiac Surgery...">{{ doctor.qualifications if doctor and doctor.qualifications else '' }}</textarea>
                        <div class="form-text">Educational qualifications and certifications</div>
                    </div>

                    <div class="mb-3">
                        <label for="qualification" class="form-label">Primary Qualification</label>
                        <input type="text" class="form-control" id="qualification" name="qualification" 
                               value="{{ doctor.qualification if doctor else '' }}" 
                               placeholder="MD, MBBS">
                        <div class="form-text">Primary medical degree</div>
                    </div>

                    <!-- Achievements & Recognition -->
                    <h5 class="mb-3 text-primary">
                        <i class="fas fa-trophy"></i> Achievements & Recognition
                    </h5>
                    
                    <div class="mb-3">
                        <label for="highlights" class="form-label">Professional Highlights</label>
                        <textarea class="form-control" id="highlights" name="highlights" rows="3"
                                  placeholder="500+ successful surgeries, Pioneer in minimally invasive techniques, Published 20+ research papers...">{{ doctor.highlights if doctor and doctor.highlights else '' }}</textarea>
                        <div class="form-text">Key achievements and notable accomplishments</div>
                    </div>

                    <div class="mb-3">
                        <label for="awards" class="form-label">Awards & Recognition</label>
                        <textarea class="form-control" id="awards" name="awards" rows="3"
                                  placeholder="Best Doctor Award 2023, Excellence in Patient Care, Outstanding Research Contribution...">{{ doctor.awards if doctor and doctor.awards else '' }}</textarea>
                        <div class="form-text">Awards, honors, and recognitions received</div>
                    </div>

                    <!-- Media & Images -->
                    <h5 class="mb-3 text-primary">
                        <i class="fas fa-camera"></i> Profile Media
                    </h5>
                    
                    <!-- Profile Photo Section -->
                    <div class="mb-3">
                        <label for="profile_photo" class="form-label">Profile Photo</label>
                        <input type="file" class="form-control" id="profile_photo" name="profile_photo" accept="image/*">
                        <div class="form-text">Professional headshot photo</div>
                        
                        {% if doctor and doctor.profile_photo %}
                        <div class="mt-3">
                            <label class="form-label">Current Profile Photo</label>
                            <div class="position-relative d-inline-block">
                                <img src="{{ doctor.profile_photo }}" alt="Profile Photo" 
                                     class="img-thumbnail profile-image" 
                                     style="width: 150px; height: 150px; object-fit: cover;">
                                <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 delete-image-btn" 
                                        data-image-type="profile" data-image-url="{{ doctor.profile_photo }}"
                                        style="transform: translate(50%, -50%);">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Additional Images Section -->
                    <div class="mb-3">
                        <label for="images" class="form-label">Additional Images</label>
                        <input type="file" class="form-control" id="images" name="images" multiple accept="image/*">
                        <div class="form-text">Additional professional photos, certifications, etc. (Drag to reorder)</div>
                        
                        {% if doctor_images %}
                        <div class="mt-3">
                            <label class="form-label">Current Additional Images</label>
                            <div id="additional-images-container" class="row g-2">
                                {% for image in doctor_images %}
                                <div class="col-md-3 image-item" data-image-id="{{ image.id }}" data-position="{{ image.position }}">
                                    <div class="position-relative">
                                        <img src="{{ image.url }}" alt="Additional Image" 
                                             class="img-thumbnail additional-image" 
                                             style="width: 100%; height: 120px; object-fit: cover; cursor: move;">
                                        <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 delete-image-btn" 
                                                data-image-type="additional" data-image-id="{{ image.id }}"
                                                style="transform: translate(50%, -50%);">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        <div class="position-absolute bottom-0 start-0 bg-dark text-white px-2 py-1 small">
                                            Position: <span class="position-number">{{ image.position or loop.index }}</span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Featured Checkbox -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_featured" id="is_featured" value="true" 
                                   {% if doctor and doctor.is_featured %}checked{% endif %}>
                            <label class="form-check-label" for="is_featured">
                                <i class="fas fa-star text-warning"></i> Featured Doctor
                            </label>
                            <div class="form-text">Featured doctors will be highlighted and shown prominently.</div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="/admin/doctors" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> {{ action }} Doctor
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Help Section -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="fas fa-info-circle"></i> Help & Guidelines</h6>
            </div>
            <div class="card-body">
                <h6>Required Fields</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-check text-success"></i> Doctor Name</li>
                    <li><i class="fas fa-check text-success"></i> Designation</li>
                    <li><i class="fas fa-check text-success"></i> Hospital</li>
                    <li><i class="fas fa-check text-success"></i> Description</li>
                </ul>

                <h6 class="mt-3">Tips for Better Profiles</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-lightbulb text-warning"></i> Use professional titles (Dr./Prof.)</li>
                    <li><i class="fas fa-lightbulb text-warning"></i> Include specific specializations</li>
                    <li><i class="fas fa-lightbulb text-warning"></i> List all qualifications</li>
                    <li><i class="fas fa-lightbulb text-warning"></i> Highlight key achievements</li>
                    <li><i class="fas fa-lightbulb text-warning"></i> Use high-quality profile photos</li>
                </ul>

                <h6 class="mt-3">Photo Guidelines</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-camera text-info"></i> Professional headshot preferred</li>
                    <li><i class="fas fa-camera text-info"></i> Good lighting and resolution</li>
                    <li><i class="fas fa-camera text-info"></i> Formal attire recommended</li>
                    <li><i class="fas fa-camera text-info"></i> Clear, uncluttered background</li>
                </ul>
            </div>
        </div>

        <!-- Statistics Card -->
        {% if action == "Update" and doctor %}
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="fas fa-chart-bar"></i> Doctor Statistics</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h5 class="text-primary mb-0">{{ doctor.treatments|length if doctor.treatments else 0 }}</h5>
                        <small class="text-muted">Treatments</small>
                    </div>
                    <div class="col-6">
                        <h5 class="text-success mb-0">{{ doctor.experience_years or 0 }}</h5>
                        <small class="text-muted">Years Exp.</small>
                    </div>
                </div>
                <hr>
                <small class="text-muted">
                    <i class="fas fa-calendar"></i> Created: {{ doctor.created_at.strftime("%B %d, %Y") }}
                </small>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Form validation and enhancement
document.addEventListener('DOMContentLoaded', function() {
    // Character count for short description
    const shortDescInput = document.getElementById('short_description');
    const shortDescHelp = shortDescInput.nextElementSibling;
    
    shortDescInput.addEventListener('input', function() {
        const length = this.value.length;
        shortDescHelp.textContent = `${length}/500 characters - Brief description for doctor cards and listings`;
        
        if (length > 500) {
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
        }
    });

    // Character count for long description
    const longDescInput = document.getElementById('long_description');
    const longDescHelp = longDescInput.nextElementSibling;
    
    longDescInput.addEventListener('input', function() {
        const length = this.value.length;
        longDescHelp.textContent = `${length} characters - Detailed description for doctor profile page`;
    });

    // Image preview for profile photo
    const profilePhotoInput = document.getElementById('profile_photo');
    profilePhotoInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                alert('Profile photo must be less than 5MB');
                this.value = '';
            }
        }
    });

    // Experience years validation
    const experienceInput = document.getElementById('experience_years');
    experienceInput.addEventListener('input', function() {
        if (this.value < 0) this.value = 0;
        if (this.value > 50) this.value = 50;
    });

    // Image deletion functionality
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-image-btn')) {
            const btn = e.target.closest('.delete-image-btn');
            const imageType = btn.getAttribute('data-image-type');
            
            if (confirm('Are you sure you want to delete this image?')) {
                if (imageType === 'profile') {
                    // Handle profile photo deletion
                    const imageContainer = btn.closest('.position-relative');
                    imageContainer.remove();
                    // You might want to add a hidden input to track deletion
                    addHiddenInput('delete_profile_photo', 'true');
                } else if (imageType === 'additional') {
                    // Handle additional image deletion
                    const imageId = btn.getAttribute('data-image-id');
                    const imageItem = btn.closest('.image-item');
                    imageItem.remove();
                    // Add hidden input to track deletion
                    addHiddenInput('delete_image_ids[]', imageId);
                    updatePositionNumbers();
                }
            }
        }
    });

    // Drag and drop functionality for additional images
    const container = document.getElementById('additional-images-container');
    if (container) {
        let draggedElement = null;

        container.addEventListener('dragstart', function(e) {
            if (e.target.closest('.image-item')) {
                draggedElement = e.target.closest('.image-item');
                draggedElement.style.opacity = '0.5';
            }
        });

        container.addEventListener('dragend', function(e) {
            if (draggedElement) {
                draggedElement.style.opacity = '1';
                draggedElement = null;
                updatePositionNumbers();
            }
        });

        container.addEventListener('dragover', function(e) {
            e.preventDefault();
        });

        container.addEventListener('drop', function(e) {
            e.preventDefault();
            const dropTarget = e.target.closest('.image-item');
            
            if (dropTarget && draggedElement && dropTarget !== draggedElement) {
                const rect = dropTarget.getBoundingClientRect();
                const midpoint = rect.left + rect.width / 2;
                
                if (e.clientX < midpoint) {
                    container.insertBefore(draggedElement, dropTarget);
                } else {
                    container.insertBefore(draggedElement, dropTarget.nextSibling);
                }
                updatePositionNumbers();
            }
        });

        // Make images draggable
        container.querySelectorAll('.image-item').forEach(item => {
            item.setAttribute('draggable', 'true');
        });
    }

    // Helper functions
    function addHiddenInput(name, value) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        document.querySelector('form').appendChild(input);
    }

    function updatePositionNumbers() {
        const container = document.getElementById('additional-images-container');
        if (container) {
            const items = container.querySelectorAll('.image-item');
            items.forEach((item, index) => {
                const positionSpan = item.querySelector('.position-number');
                if (positionSpan) {
                    positionSpan.textContent = index + 1;
                }
                item.setAttribute('data-position', index + 1);
                
                // Add hidden input for new position
                const imageId = item.getAttribute('data-image-id');
                addHiddenInput('image_positions[' + imageId + ']', index + 1);
            });
        }
    }

    // Consultancy fee validation
    const consultancyFeeInput = document.getElementById('consultancy_fee');
    if (consultancyFeeInput) {
        consultancyFeeInput.addEventListener('input', function() {
            if (this.value < 0) this.value = 0;
        });
    }

});
</script>

<!-- Add SortableJS for better drag and drop (optional enhancement) -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// Enhanced drag and drop with SortableJS
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('additional-images-container');
    if (container && typeof Sortable !== 'undefined') {
        new Sortable(container, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onEnd: function(evt) {
                updatePositionNumbers();
            }
        });
    }
});
</script>

<style>
.sortable-ghost {
    opacity: 0.4;
}

.sortable-chosen {
    transform: scale(1.05);
}

.image-item {
    transition: transform 0.2s ease;
}

.image-item:hover {
    transform: scale(1.02);
}

.delete-image-btn {
    z-index: 10;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.delete-image-btn:hover {
    background-color: #dc3545 !important;
    transform: translate(50%, -50%) scale(1.1);
}
</style>
{% endblock %}