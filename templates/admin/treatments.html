{% extends "base.html" %}

{% block title %}Treatment Management - Admin Panel{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                <div>
                    <h1 class="h3 mb-0">Treatment Management</h1>
                    <p class="text-muted mb-0">Manage medical treatments and procedures</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="/admin/treatments/new" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i> Add Treatment
                    </a>
                    <a href="/admin/dashboard" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3 mb-md-0">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="card-title mb-0">{{ total }}</h4>
                            <p class="card-text mb-0">Total Treatments</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-procedures fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Treatments Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center mb-3">
                        <div class="col-md-6">
                            <h5 class="card-title mb-0">All Treatments (<span id="totalCount">{{ total }}</span> total)</h5>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <button class="btn btn-success btn-sm" onclick="exportTreatments()">
                                <i class="fas fa-download me-1"></i>Export
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filter Controls -->
                    <div class="row g-2">
                        <div class="col-12 col-sm-6 col-md-3 col-lg-2">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" placeholder="Search..." id="searchInput">
                                <button class="btn btn-outline-secondary" type="button" title="Search all treatments" onclick="performServerSearch()">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-12 col-sm-6 col-md-3 col-lg-2">
                            <select class="form-select form-select-sm" id="typeFilter">
                                <option value="">All Types</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div class="col-12 col-sm-6 col-md-3 col-lg-2">
                            <select class="form-select form-select-sm" id="hospitalFilter">
                                <option value="">All Hospitals</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div class="col-12 col-sm-6 col-md-3 col-lg-2">
                            <select class="form-select form-select-sm" id="doctorFilter">
                                <option value="">All Doctors</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div class="col-12 col-sm-6 col-md-3 col-lg-2">
                            <select class="form-select form-select-sm" id="priceFilter">
                                <option value="">All Prices</option>
                                <option value="0-1000">₹0-₹1000</option>
                                <option value="1000-5000">₹1K-₹5K</option>
                                <option value="5000-10000">₹5K-₹10K</option>
                                <option value="10000-50000">₹10K-₹50K</option>
                                <option value="50000+">₹50K+</option>
                            </select>
                        </div>
                        <div class="col-12 col-sm-6 col-md-3 col-lg-2">
                            <select class="form-select form-select-sm" id="ratingFilter">
                                <option value="">All Ratings</option>
                                <option value="5">5 Stars</option>
                                <option value="4">4+ Stars</option>
                                <option value="3">3+ Stars</option>
                                <option value="2">2+ Stars</option>
                                <option value="1">1+ Stars</option>
                            </select>
                        </div>
                        <div class="col-12 col-sm-6 col-md-3 col-lg-2">
                            <select class="form-select form-select-sm" id="locationFilter">
                                <option value="">All Locations</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div class="col-12 col-sm-6 col-md-3 col-lg-2">
                            <select class="form-select form-select-sm" id="ayushmanFilter">
                                <option value="">All Treatments</option>
                                <option value="ayushman">Ayushman Bharat</option>
                                <option value="non-ayushman">Non-Ayushman</option>
                            </select>
                        </div>
                        <div class="col-12 col-sm-6 col-md-3 col-lg-2">
                            <select class="form-select form-select-sm" id="isActiveFilter">
                                <option value="">All Status</option>
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                            </select>
                        </div>
                        <div class="col-12 col-sm-6 col-md-3 col-lg-2">
                            <select class="form-select form-select-sm" id="isFeaturedFilter">
                                <option value="">Featured Status</option>
                                    <option value="true">Featured</option>
                                    <option value="false">Not Featured</option>
                            </select>
                        </div>
                        <div class="col-12 col-sm-6 col-md-3 col-lg-2">
                            <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters()" title="Clear all filters">
                                <i class="fas fa-times me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% if treatments %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Treatment ID</th>
                                    <th>Name & Details</th>
                                    <th>Description</th>
                                    <th>Price</th>
                                    <th>Rating</th>
                                    <th>Location</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for treatment in treatments %}
                                <tr data-name="{{ treatment.name|lower }}"
                                    data-type="{{ treatment.treatment_type|lower if treatment.treatment_type else '' }}"
                                    data-hospital="{{ treatment.hospital.name|lower if treatment.hospital else (treatment.other_hospital_name|lower if treatment.other_hospital_name else '') }}"
                                    data-doctor="{{ treatment.doctor.name|lower if treatment.doctor else (treatment.other_doctor_name|lower if treatment.other_doctor_name else '') }}"
                                    data-location="{{ treatment.location|lower if treatment.location else '' }}"
                                    data-is-active="{{ 'true' if treatment.is_active else 'false' }}"
                                    data-is-featured="{{ 'true' if treatment.is_featured else 'false' }}"
                                    data-price-exact="{{ treatment.price_exact if treatment.price_exact else 0 }}"
                                    data-price-min="{{ treatment.price_min if treatment.price_min else 0 }}"
                                    data-price-max="{{ treatment.price_max if treatment.price_max else 0 }}"
                                    data-rating="{{ treatment.rating if treatment.rating else 0 }}"
                                    data-description="{{ treatment.short_description|lower if treatment.short_description else '' }}"
                                    data-is-ayushman="{{ 'true' if treatment.is_ayushman else 'false' }}">
                                    <td>
                                        <strong>#{{ treatment.id }}</strong>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column">
                                            
                                            <strong>{{ treatment.name }}</strong>
                                            <div class="small text-muted mt-1">
                                                {% if treatment.treatment_type %}
                                                <span class="d-block"><i class="fas fa-tag me-1"></i> {{ treatment.treatment_type }}</span>
                                                {% endif %}
                                                {% if treatment.hospital %}
                                                <span class="d-block text-primary"><i class="fas fa-hospital me-1"></i> {{ treatment.hospital.name }}</span>
                                                {% elif treatment.other_hospital_name %}
                                                <span class="d-block text-primary"><i class="fas fa-hospital me-1"></i> {{ treatment.other_hospital_name }}</span>
                                                {% endif %}
                                                {% if treatment.doctor %}
                                                <span class="d-block text-success"><i class="fas fa-user-md me-1"></i>{{ treatment.doctor.name }}</span>
                                                {% elif treatment.other_doctor_name %}
                                                <span class="d-block text-success"><i class="fas fa-user-md me-1"></i>{{ treatment.other_doctor_name }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if treatment.short_description %}
                                        <span class="text-truncate d-inline-block" style="max-width: 200px;" 
                                              title="{{ treatment.short_description }}">
                                            {{ treatment.short_description[:100] }}{% if treatment.short_description|length > 100 %}...{% endif %}
                                        </span>
                                        {% else %}
                                        <em class="text-muted">No description</em>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if treatment.price_exact %}
                                        <span class="badge bg-success">₹{{ "%.2f"|format(treatment.price_exact) }}</span>
                                        {% elif treatment.price_min and treatment.price_max %}
                                        <span class="badge bg-info">₹{{ "%.2f"|format(treatment.price_min) }} - ₹{{ "%.2f"|format(treatment.price_max) }}</span>
                                        {% elif treatment.price_min %}
                                        <span class="badge bg-info">From ₹{{ "%.2f"|format(treatment.price_min) }}</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Price on request</span>
                                        {% endif %}
                                        {% if treatment.is_ayushman %}
                                        <br><span class="badge bg-success mt-1"><i class="fas fa-file-medical"></i> Ayushman</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if treatment.rating %}
                                            <div class="d-flex align-items-center">
                                                <span class="me-1">{{ "%.1f"|format(treatment.rating) }}</span>
                                                <div class="text-warning">
                                                    {% for i in range(5) %}
                                                        {% if i < treatment.rating %}
                                                            <i class="fas fa-star"></i>
                                                        {% elif i < treatment.rating + 0.5 %}
                                                            <i class="fas fa-star-half-alt"></i>
                                                        {% else %}
                                                            <i class="far fa-star"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">No rating</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if treatment.location %}
                                        {{ treatment.location }}
                                        {% else %}
                                        <em class="text-muted">Location not specified</em>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ treatment.created_at.strftime("%Y-%m-%d") if treatment.created_at else "N/A" }}
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="/admin/treatments/{{ treatment.id }}/edit" 
                                               class="btn btn-outline-primary" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-outline-danger delete-btn" 
                                                    data-treatment-id="{{ treatment.id }}" 
                                                    data-treatment-name="{{ treatment.name }}"
                                                    title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if total_pages > 1 %}
                    <nav aria-label="Treatments pagination" class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if page > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="/admin/treatments?page={{ page - 1 }}">Previous</a>
                            </li>
                            {% endif %}
                            
                            {% for p in range(1, total_pages + 1) %}
                            <li class="page-item {% if p == page %}active{% endif %}">
                                <a class="page-link" href="/admin/treatments?page={{ p }}">{{ p }}</a>
                            </li>
                            {% endfor %}
                            
                            {% if page < total_pages %}
                            <li class="page-item">
                                <a class="page-link" href="/admin/treatments?page={{ page + 1 }}">Next</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-procedures fa-3x text-muted mb-3"></i>
                        <h5>No treatments found</h5>
                        <p class="text-muted">Start by adding your first treatment.</p>
                        <a href="/admin/treatments/new" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add First Treatment
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this treatment?</p>
                <p><strong id="treatmentName"></strong></p>
                <p class="text-danger"><small>This action cannot be undone.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Treatment</button>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize filters when page loads
document.addEventListener('DOMContentLoaded', function() {
    populateFilterOptions();
    setupFilterListeners();
    setupDeleteHandlers();
    populateSearchFromQuery(); // populate search box from URL query
});

// If user presses Enter in the search box, perform a server-side query
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performServerSearch();
            }
        });
    }
});

// Read `search` param from URL and populate the search input
function populateSearchFromQuery() {
    const params = new URLSearchParams(window.location.search);
    const search = params.get('search');
    if (search) {
        const input = document.getElementById('searchInput');
        if (input) input.value = search;
    }
    // populate new boolean filters from query
    const isActive = params.get('is_active');
    const isFeatured = params.get('is_featured');
    if (isActive) {
        const el = document.getElementById('isActiveFilter');
        if (el) el.value = isActive;
    }
    if (isFeatured) {
        const el = document.getElementById('isFeaturedFilter');
        if (el) el.value = isFeatured;
    }
}

// Build URL with current filters and navigate to server-side search
function performServerSearch() {
    const searchTerm = document.getElementById('searchInput').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const hospitalFilter = document.getElementById('hospitalFilter').value;
    const doctorFilter = document.getElementById('doctorFilter').value;
    const priceFilter = document.getElementById('priceFilter') ? document.getElementById('priceFilter').value : '';
    const ratingFilter = document.getElementById('ratingFilter') ? document.getElementById('ratingFilter').value : '';
    const locationFilter = document.getElementById('locationFilter') ? document.getElementById('locationFilter').value : '';
    const ayushmanFilter = document.getElementById('ayushmanFilter') ? document.getElementById('ayushmanFilter').value : '';
    const isActiveFilter = document.getElementById('isActiveFilter') ? document.getElementById('isActiveFilter').value : '';
    const isFeaturedFilter = document.getElementById('isFeaturedFilter') ? document.getElementById('isFeaturedFilter').value : '';

    const params = new URLSearchParams();
    if (searchTerm) params.append('search', searchTerm);
    if (typeFilter) params.append('type', typeFilter);
    if (hospitalFilter) params.append('hospital', hospitalFilter);
    if (doctorFilter) params.append('doctor', doctorFilter);
    if (priceFilter) params.append('price', priceFilter);
    if (ratingFilter) params.append('rating', ratingFilter);
    if (locationFilter) params.append('location', locationFilter);
    if (ayushmanFilter) params.append('ayushman', ayushmanFilter);
    if (isActiveFilter) params.append('is_active', isActiveFilter);
    if (isFeaturedFilter) params.append('is_featured', isFeaturedFilter);

    // Reset to first page when doing a new server search
    const baseUrl = window.location.pathname;
    const url = params.toString() ? `${baseUrl}?${params.toString()}` : baseUrl;
    window.location.href = url;
}

// Setup event listeners for all filters
function setupFilterListeners() {
    document.getElementById('searchInput').addEventListener('input', filterTreatments);
    const typeEl = document.getElementById('typeFilter');
    if (typeEl) typeEl.addEventListener('change', performServerSearch);
    const hospitalEl = document.getElementById('hospitalFilter');
    if (hospitalEl) hospitalEl.addEventListener('change', performServerSearch);
    const doctorEl = document.getElementById('doctorFilter');
    if (doctorEl) doctorEl.addEventListener('change', performServerSearch);
    document.getElementById('priceFilter').addEventListener('change', filterTreatments);
    document.getElementById('ratingFilter').addEventListener('change', filterTreatments);
    const locationEl = document.getElementById('locationFilter');
    if (locationEl) locationEl.addEventListener('change', performServerSearch);
    document.getElementById('ayushmanFilter').addEventListener('change', filterTreatments);
    const isActiveEl = document.getElementById('isActiveFilter');
    if (isActiveEl) isActiveEl.addEventListener('change', function() { performServerSearch(); });
    const isFeaturedEl = document.getElementById('isFeaturedFilter');
    if (isFeaturedEl) isFeaturedEl.addEventListener('change', function() { performServerSearch(); });
}

// Populate filter dropdown options from existing data
function populateFilterOptions() {
    // Try to load full filter lists from the API (covers all treatments)
    (async () => {
        // capture query params to restore selected values after population
        const params = new URLSearchParams(window.location.search);
        const selectedTypeParam = params.get('type');
        const selectedHospitalParam = params.get('hospital');
        const selectedDoctorParam = params.get('doctor');
        const selectedLocationParam = params.get('location');

        function setSelectValueCaseInsensitive(selectEl, value) {
            if (!value || !selectEl) return;
            // direct set first
            try { selectEl.value = value; if (selectEl.value === value) return; } catch (e) {}
            // fallback: match ignoring case
            const lower = value.toString().toLowerCase();
            for (let i = 0; i < selectEl.options.length; i++) {
                if ((selectEl.options[i].value || '').toString().toLowerCase() === lower) {
                    selectEl.selectedIndex = i;
                    return;
                }
            }
        }
        try {
            const [typesResp, locationsResp, hospitalsResp, doctorsResp] = await Promise.all([
                fetch('/api/v1/filters/treatment-types'),
                fetch('/api/v1/filters/locations'),
                fetch('/api/v1/hospitals?limit=1000'),
                fetch('/api/v1/doctors?limit=1000')
            ]);

            if (!typesResp.ok || !locationsResp.ok || !hospitalsResp.ok || !doctorsResp.ok) {
                throw new Error('One or more filter endpoints failed');
            }

            const types = await typesResp.json();
            const locations = await locationsResp.json();
            const hospitals = await hospitalsResp.json();
            const doctors = await doctorsResp.json();

            // Populate type filter
            const typeFilter = document.getElementById('typeFilter');
            // remove existing dynamic options
            Array.from(typeFilter.querySelectorAll('option:not(:first-child)')).forEach(n => n.remove());
            types.sort().forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                typeFilter.appendChild(option);
            });

            // restore selected type from query if present
            setSelectValueCaseInsensitive(typeFilter, selectedTypeParam);

            // Populate location filter
            const locationFilter = document.getElementById('locationFilter');
            Array.from(locationFilter.querySelectorAll('option:not(:first-child)')).forEach(n => n.remove());
            locations.sort().forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc.charAt(0).toUpperCase() + loc.slice(1);
                locationFilter.appendChild(option);
            });

            // restore selected location from query if present
            setSelectValueCaseInsensitive(locationFilter, selectedLocationParam);

            // Populate hospital filter (use names)
            const hospitalFilter = document.getElementById('hospitalFilter');
            Array.from(hospitalFilter.querySelectorAll('option:not(:first-child)')).forEach(n => n.remove());
            // hospitals may be objects; try to extract name
            hospitals.sort((a,b) => {
                const na = (a.name||a).toString().toLowerCase();
                const nb = (b.name||b).toString().toLowerCase();
                return na < nb ? -1 : na > nb ? 1 : 0;
            }).forEach(h => {
                const name = (h.name || h).toString();
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name.charAt(0).toUpperCase() + name.slice(1);
                hospitalFilter.appendChild(option);
            });

            // restore selected hospital from query if present
            setSelectValueCaseInsensitive(hospitalFilter, selectedHospitalParam);

            // Populate doctor filter (use names)
            const doctorFilter = document.getElementById('doctorFilter');
            Array.from(doctorFilter.querySelectorAll('option:not(:first-child)')).forEach(n => n.remove());
            doctors.sort((a,b) => {
                const na = (a.name||a).toString().toLowerCase();
                const nb = (b.name||b).toString().toLowerCase();
                return na < nb ? -1 : na > nb ? 1 : 0;
            }).forEach(d => {
                const name = (d.name || d).toString();
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name.charAt(0).toUpperCase() + name.slice(1);
                doctorFilter.appendChild(option);
            });

            // restore selected doctor from query if present
            setSelectValueCaseInsensitive(doctorFilter, selectedDoctorParam);

            return;
        } catch (err) {
            console.warn('Falling back to page-based filter population:', err);
            // fallback to current-page population below
        }
        
        // Fallback: populate from current page rows (keeps previous behavior if API unavailable)
        const rows = document.querySelectorAll('tbody tr');
        const typesSet = new Set();
        const hospitalsSet = new Set();
        const doctorsSet = new Set();
        const locationsSet = new Set();
        
        rows.forEach(row => {
            const type = row.dataset.type;
            if (type && type.trim()) typesSet.add(type.trim());
            const hospital = row.dataset.hospital;
            if (hospital && hospital.trim()) hospitalsSet.add(hospital.trim());
            const doctor = row.dataset.doctor;
            if (doctor && doctor.trim()) doctorsSet.add(doctor.trim());
            const location = row.dataset.location;
            if (location && location.trim()) locationsSet.add(location.trim());
        });

        // Populate type filter
        const typeFilter = document.getElementById('typeFilter');
        const sortedTypes = Array.from(typesSet).sort();
        sortedTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
            typeFilter.appendChild(option);
        });

        // Populate hospital filter
        const hospitalFilter = document.getElementById('hospitalFilter');
        const sortedHospitals = Array.from(hospitalsSet).sort();
        sortedHospitals.forEach(hospital => {
            const option = document.createElement('option');
            option.value = hospital;
            option.textContent = hospital.charAt(0).toUpperCase() + hospital.slice(1);
            hospitalFilter.appendChild(option);
        });

        // Populate doctor filter
        const doctorFilter = document.getElementById('doctorFilter');
        const sortedDoctors = Array.from(doctorsSet).sort();
        sortedDoctors.forEach(doctor => {
            const option = document.createElement('option');
            option.value = doctor;
            option.textContent = doctor.charAt(0).toUpperCase() + doctor.slice(1);
            doctorFilter.appendChild(option);
        });

        // Populate location filter
        const locationFilter = document.getElementById('locationFilter');
        const sortedLocations = Array.from(locationsSet).sort();
        sortedLocations.forEach(location => {
            const option = document.createElement('option');
            option.value = location;
            option.textContent = location.charAt(0).toUpperCase() + location.slice(1);
            locationFilter.appendChild(option);
        });
    })();
}

// Main filtering function
function filterTreatments() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value.toLowerCase();
    const hospitalFilter = document.getElementById('hospitalFilter').value.toLowerCase();
    const doctorFilter = document.getElementById('doctorFilter').value.toLowerCase();
    const priceFilter = document.getElementById('priceFilter').value;
    const ratingFilter = document.getElementById('ratingFilter').value;
    const locationFilter = document.getElementById('locationFilter').value.toLowerCase();
    const ayushmanFilter = document.getElementById('ayushmanFilter').value;
    const isActiveFilter = document.getElementById('isActiveFilter') ? document.getElementById('isActiveFilter').value : '';
    const isFeaturedFilter = document.getElementById('isFeaturedFilter') ? document.getElementById('isFeaturedFilter').value : '';
    
    const rows = document.querySelectorAll('tbody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const name = row.dataset.name || '';
        const type = row.dataset.type || '';
        const hospital = row.dataset.hospital || '';
        const doctor = row.dataset.doctor || '';
        const location = row.dataset.location || '';
        const description = row.dataset.description || '';
        const priceExact = parseFloat(row.dataset.priceExact || '0');
        const priceMin = parseFloat(row.dataset.priceMin || '0');
        const priceMax = parseFloat(row.dataset.priceMax || '0');
        const rating = parseFloat(row.dataset.rating || '0');
        const isAyushman = row.dataset.isAyushman === 'true';
        const isActive = row.dataset.isActive === 'true';
        const isFeatured = row.dataset.isFeatured === 'true';
        
        // Check all filter conditions
        const matchesSearch = !searchTerm || 
                            name.includes(searchTerm) || 
                            type.includes(searchTerm) ||
                            hospital.includes(searchTerm) ||
                            doctor.includes(searchTerm) ||
                            location.includes(searchTerm) ||
                            description.includes(searchTerm);
        
        const matchesType = !typeFilter || type === typeFilter;
        
        const matchesHospital = !hospitalFilter || hospital === hospitalFilter;
        
        const matchesDoctor = !doctorFilter || doctor === doctorFilter;
        
        const matchesLocation = !locationFilter || location === locationFilter;
        
        // Price filtering logic
        let matchesPrice = true;
        if (priceFilter) {
            const effectivePrice = priceExact || priceMin || priceMax || 0;
            
            if (priceFilter === '0-1000') {
                matchesPrice = effectivePrice <= 1000;
            } else if (priceFilter === '1000-5000') {
                matchesPrice = effectivePrice >= 1000 && effectivePrice <= 5000;
            } else if (priceFilter === '5000-10000') {
                matchesPrice = effectivePrice >= 5000 && effectivePrice <= 10000;
            } else if (priceFilter === '10000-50000') {
                matchesPrice = effectivePrice >= 10000 && effectivePrice <= 50000;
            } else if (priceFilter === '50000+') {
                matchesPrice = effectivePrice >= 50000;
            }
        }
        
        const matchesRating = !ratingFilter || rating >= parseFloat(ratingFilter);
        
        // Ayushman filtering logic
        let matchesAyushman = true;
        if (ayushmanFilter) {
            if (ayushmanFilter === 'ayushman') {
                matchesAyushman = isAyushman;
            } else if (ayushmanFilter === 'non-ayushman') {
                matchesAyushman = !isAyushman;
            }
        }

        // is_active filtering logic (accept both 'true'/'false' and legacy 'active'/'inactive')
        let matchesIsActive = true;
        const isActiveFilterVal = document.getElementById('isActiveFilter') ? document.getElementById('isActiveFilter').value : '';
        if (isActiveFilterVal) {
            if (isActiveFilterVal === 'active' || isActiveFilterVal === 'true') matchesIsActive = isActive;
            else if (isActiveFilterVal === 'inactive' || isActiveFilterVal === 'false') matchesIsActive = !isActive;
        }

        // is_featured filtering logic (accept both 'true'/'false' and legacy 'featured'/'not-featured')
        let matchesIsFeatured = true;
        const isFeaturedFilterVal2 = document.getElementById('isFeaturedFilter') ? document.getElementById('isFeaturedFilter').value : '';
        if (isFeaturedFilterVal2) {
            if (isFeaturedFilterVal2 === 'featured' || isFeaturedFilterVal2 === 'true') matchesIsFeatured = isFeatured;
            else if (isFeaturedFilterVal2 === 'not-featured' || isFeaturedFilterVal2 === 'false') matchesIsFeatured = !isFeatured;
        }
        
        // Show/hide row based on all filters
        if (matchesSearch && matchesType && matchesHospital && matchesDoctor && 
            matchesLocation && matchesPrice && matchesRating && matchesAyushman && matchesIsActive && matchesIsFeatured) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update total count
    document.getElementById('totalCount').textContent = visibleCount;
}

// Clear all filters
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('hospitalFilter').value = '';
    document.getElementById('doctorFilter').value = '';
    const isActiveEl = document.getElementById('isActiveFilter'); if (isActiveEl) isActiveEl.value = '';
    const isFeaturedEl = document.getElementById('isFeaturedFilter'); if (isFeaturedEl) isFeaturedEl.value = '';
    document.getElementById('priceFilter').value = '';
    document.getElementById('ratingFilter').value = '';
    document.getElementById('locationFilter').value = '';
    document.getElementById('ayushmanFilter').value = '';
    // After clearing inputs, perform a server-side search (will navigate to base URL without queryparams)
    performServerSearch();
}

// Export treatments with current filters
function exportTreatments() {
    // Get the export button and store original text
    const button = document.querySelector('button[onclick="exportTreatments()"]');
    const originalText = button.innerHTML;
    
    // Show loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Exporting...';
    button.disabled = true;
    
    // Build export URL with current filters
    const searchTerm = document.getElementById('searchInput').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const hospitalFilter = document.getElementById('hospitalFilter').value;
    const doctorFilter = document.getElementById('doctorFilter').value;
    const priceFilter = document.getElementById('priceFilter').value;
    const ratingFilter = document.getElementById('ratingFilter').value;
    const locationFilter = document.getElementById('locationFilter').value;
    const ayushmanFilter = document.getElementById('ayushmanFilter').value;
    
    // Build URL parameters
    const params = new URLSearchParams();
    params.append('export', 'true');
    
    if (searchTerm) params.append('search', searchTerm);
    if (typeFilter) params.append('type', typeFilter);
    if (hospitalFilter) params.append('hospital', hospitalFilter);
    if (doctorFilter) params.append('doctor', doctorFilter);
    if (priceFilter) params.append('price', priceFilter);
    if (ratingFilter) params.append('rating', ratingFilter);
    if (locationFilter) params.append('location', locationFilter);
    if (ayushmanFilter) params.append('ayushman', ayushmanFilter);
    if (isActiveFilter) params.append('is_active', isActiveFilter);
    if (isFeaturedFilter) params.append('is_featured', isFeaturedFilter);
    
    // Create the full URL for export
    const baseUrl = window.location.href.split('?')[0]; // Get base URL without query params
    const exportUrl = `${baseUrl}?${params.toString()}`;
    
    // Use fetch API to trigger download
    fetch(exportUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.blob();
        })
        .then(blob => {
            // Create a temporary link to trigger download
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `treatments_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error('Export error:', error);
            alert('Export failed. Please try again.');
        })
        .finally(() => {
            // Reset button after a short delay
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
        });
}

// Setup delete button handlers
function setupDeleteHandlers() {
    // Handle delete button clicks
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function() {
            const treatmentId = this.getAttribute('data-treatment-id');
            const treatmentName = this.getAttribute('data-treatment-name');
            
            document.getElementById('treatmentName').textContent = treatmentName;
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
            
            document.getElementById('confirmDeleteBtn').onclick = async function() {
                try {
                    const response = await fetch(`/admin/treatments/${treatmentId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        modal.hide();
                        alert(`${treatmentName} has been deleted successfully.`);
                        location.reload();
                    } else {
                        modal.hide();
                        alert(`Error deleting ${treatmentName}: ${data.detail || 'Unknown error'}`);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    modal.hide();
                    alert(`Error deleting ${treatmentName}: ${error.message}`);
                }
            };
        });
    });
}
</script>
{% endblock %}