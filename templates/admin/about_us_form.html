{% extends 'admin/base.html' %}
{% block content %}
<h1 class="mb-4">{% if action=='create' %}Create About Us{% else %}Edit About Us{% endif %}</h1>

<form method="post" enctype="multipart/form-data" action="{% if action=='create' %}/admin/about-us{% else %}/admin/about-us/{{ item.id }}{% endif %}">
  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card p-3 mb-3">
        <div class="mb-3">
          <label class="form-label">Heading</label>
          <input type="text" name="heading" class="form-control form-control-lg" value="{{ item.heading if item else '' }}" required />
        </div>
        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea name="description" class="form-control" rows="4">{{ item.description if item else '' }}</textarea>
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Vision Heading</label>
            <input type="text" name="vision_heading" class="form-control" value="{{ item.vision_heading if item else '' }}" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Vision Description</label>
            <input type="text" name="vision_desc" class="form-control" value="{{ item.vision_desc if item else '' }}" />
          </div>
        </div>
        <div class="mb-3 mt-2">
          <label class="form-label">Mission</label>
          <textarea name="mission" class="form-control" rows="3">{{ item.mission if item else '' }}</textarea>
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Bottom Heading</label>
            <input type="text" name="bottom_heading" class="form-control" value="{{ item.bottom_heading if item else '' }}" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Bottom List (one item per line)</label>
            <textarea name="bottom_list" class="form-control" rows="4" placeholder="Enter one list item per line">{% if item and item.bottom_list %}{{ item.bottom_list.split(',')|map('trim')|join('\n') }}{% endif %}</textarea>
            <small class="form-text text-muted">Use a new line for each list item. The server will parse lines into list entries.</small>
          </div>
        </div>
        <div class="mb-3 mt-2">
          <label class="form-label">Bottom Description</label>
          <textarea name="bottom_desc" class="form-control" rows="2">{{ item.bottom_desc if item else '' }}</textarea>
        </div>
      </div>

      <div class="card p-3 mb-3">
        <div class="mb-3">
          <label class="form-label">Feature Title</label>
          <input type="text" name="feature_title" class="form-control" value="{{ item.feature_title if item else '' }}" />
        </div>
        <div class="mb-3">
          <label class="form-label">Feature Description</label>
          <textarea name="feature_desc" class="form-control" rows="2">{{ item.feature_desc if item else '' }}</textarea>
        </div>
        <div class="d-flex gap-3 align-items-center">
          <div class="form-check">
            <input type="checkbox" class="form-check-input" name="is_featured" value="true" id="is_featured" {% if item and item.is_featured %}checked{% endif %} />
            <label class="form-check-label" for="is_featured">Featured</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" name="is_active" value="true" id="is_active" {% if item and item.is_active %}checked{% endif %} />
            <label class="form-check-label" for="is_active">Active</label>
          </div>
        </div>
      </div>

      <div class="card p-3 mb-3">
        <h5 class="mb-2">Section Images</h5>
        <p class="text-muted small mb-2">Upload images used in the About Us section. Existing images are shown below â€” check to remove.</p>
        <div id="about-images-list" class="d-flex flex-wrap gap-2 mb-2">
          {% if about_images %}
            {% for img in about_images %}
              <div class="position-relative border rounded p-1 bg-white" style="width:110px;">
                <img src="{{ img.url }}" alt="about image" class="img-fluid" style="height:80px; width:100%; object-fit:cover; display:block;" />
                <div class="form-check mt-1">
                  <input class="form-check-input" type="checkbox" name="image_delete[]" value="{{ img.id }}" id="delimg-{{ img.id }}" />
                  <label class="form-check-label small" for="delimg-{{ img.id }}">Delete</label>
                </div>
              </div>
            {% endfor %}
          {% endif %}
        </div>
        <div class="mb-2">
          <label class="form-label">Upload Section Images</label>
          <input type="file" name="about_images[]" multiple class="form-control" id="about_images_input" />
        </div>
        <div id="about-images-preview" class="d-flex flex-wrap gap-2"></div>
      </div>

      <div class="card p-3 mb-3">
        <h5 class="mb-2">Featured Cards</h5>
        <p class="text-muted small mb-2">Manage small feature cards associated with this About Us section.</p>
        <div id="featured-cards-wrapper" class="d-flex flex-column gap-2">
          {% if item and item.featured_cards %}
            {% for card in item.featured_cards %}
              <div class="card p-3 featured-card-row">
                <input type="hidden" name="featured_id[]" value="{{ card.id }}" />
                <div class="row g-2 align-items-center">
                  <div class="col-md-5">
                    <label class="form-label">Heading</label>
                    <input type="text" name="featured_heading[]" class="form-control" value="{{ card.heading }}" />
                  </div>
                  <div class="col-md-5">
                    <label class="form-label">Description</label>
                    <input type="text" name="featured_description[]" class="form-control" value="{{ card.description }}" />
                  </div>
                  <div class="col-md-2 d-flex justify-content-end">
                    <div class="form-check me-2">
                      <input type="checkbox" class="form-check-input" name="featured_delete[]" value="{{ card.id }}" id="del-{{ card.id }}" />
                      <label class="form-check-label small" for="del-{{ card.id }}">Delete</label>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-featured">Remove</button>
                  </div>
                </div>
                {% set fimgs = featured_images_map.get(card.id) if featured_images_map else None %}
                {% if fimgs %}
                <div class="mt-2 d-flex flex-wrap gap-2">
                  {% for fimg in fimgs %}
                  <div class="position-relative border rounded p-1" style="width:90px;">
                    <img src="{{ fimg.url }}" alt="featured image" class="img-fluid" style="height:60px; width:100%; object-fit:cover; display:block;" />
                    <div class="form-check mt-1">
                      <input class="form-check-input" type="checkbox" name="image_delete[]" value="{{ fimg.id }}" id="fdel-{{ fimg.id }}" />
                      <label class="form-check-label small" for="fdel-{{ fimg.id }}">Delete</label>
                    </div>
                  </div>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
            {% endfor %}
          {% endif %}
        </div>
        <div class="mt-3">
          <button type="button" id="add-featured-card" class="btn btn-sm btn-outline-primary">Add Featured Card</button>
        </div>
      </div>

    </div>
    <div class="col-lg-4">
      <div class="card p-3 mb-3 sticky-top" style="top:20px;">
        <h6 class="mb-3">Actions</h6>
        <div class="d-grid gap-2">
          <button class="btn btn-success" type="submit">Save</button>
          <a href="/admin/about-us" class="btn btn-outline-secondary">Cancel</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      // About images preview
      const input = document.getElementById('about_images_input');
      const preview = document.getElementById('about-images-preview');
      function makeThumb(file){
        const url = URL.createObjectURL(file);
        const wrap = document.createElement('div');
        wrap.className = 'border rounded p-1 bg-white';
        wrap.style.width = '110px';
        wrap.innerHTML = `<img src="${url}" style="height:80px;width:100%;object-fit:cover;display:block;" />`;
        return wrap;
      }
      if(input){
        input.addEventListener('change', function(e){
          preview.innerHTML = '';
          Array.from(input.files).forEach(function(f){ preview.appendChild(makeThumb(f)); });
        });
      }

      // Featured cards add/remove
      const wrapper = document.getElementById('featured-cards-wrapper');
      const addBtn = document.getElementById('add-featured-card');
      function makeRow() {
        const div = document.createElement('div');
        div.className = 'card p-3 featured-card-row';
        div.innerHTML = `
          <input type="hidden" name="featured_id[]" value="" />
          <div class="row g-2 align-items-center">
            <div class="col-md-5">
              <label class="form-label">Heading</label>
              <input type="text" name="featured_heading[]" class="form-control" value="" />
            </div>
            <div class="col-md-5">
              <label class="form-label">Description</label>
              <input type="text" name="featured_description[]" class="form-control" value="" />
            </div>
            <div class="col-md-2 d-flex justify-content-end">
              <div class="form-check me-2">
                <input type="checkbox" class="form-check-input" name="featured_delete[]" value="" />
                <label class="form-check-label small">Delete</label>
              </div>
              <button type="button" class="btn btn-sm btn-outline-danger remove-featured">Remove</button>
            </div>
          </div>
        `;
        return div;
      }
      addBtn.addEventListener('click', function(){
        const row = makeRow();
        wrapper.appendChild(row);
        row.querySelector('.remove-featured').addEventListener('click', function(){ row.remove(); });
      });
      // attach remove handlers for any initial rows that have Remove buttons
      document.querySelectorAll('.remove-featured').forEach(function(btn){
        btn.addEventListener('click', function(){ btn.closest('.featured-card-row').remove(); });
      });

    })();
  </script>
</form>
{% endblock %}