{% extends "base.html" %}

{% block title %}{{ action }} Hospital - Admin Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-hospital"></i> {{ action }} Hospital</h2>
    <a href="/admin/hospitals" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Hospitals
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Hospital Information</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="/admin/hospitals{% if hospital %}/{{ hospital.id }}{% endif %}" enctype="multipart/form-data">
                    
                    <!-- Basic Information -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Hospital Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   value="{{ hospital.name if hospital else '' }}" required
                                   placeholder="Central Medical Hospital">
                            <div class="form-text">Enter the full hospital name</div>
                        </div>
                        <div class="col-md-6">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phone" name="phone" 
                                   value="{{ hospital.phone if hospital else '' }}"
                                   placeholder="+1-555-0123">
                            <div class="form-text">Primary contact number</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="email" name="email" 
                                   value="{{ hospital.email if hospital else '' }}"
                                   placeholder="info@hospital.com">
                            <div class="form-text">Primary email address</div>
                        </div>
                        <div class="col-md-6">
                            <label for="location" class="form-label">Location <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="location" name="location" 
                                   value="{{ hospital.location if hospital else '' }}" required
                                   placeholder="New York, NY, USA">
                            <div class="form-text">City, State, Country</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="address" class="form-label">Full Address</label>
                        <textarea class="form-control" id="address" name="address" rows="2"
                                  placeholder="123 Medical Center Drive, Suite 100">{{ hospital.address if hospital else '' }}</textarea>
                        <div class="form-text">Complete street address</div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="4"
                                  placeholder="Brief description of the hospital, its mission, and key services...">{{ hospital.description if hospital else '' }}</textarea>
                        <div class="form-text">Hospital overview and key information</div>
                    </div>

                    <!-- Rating -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="rating" class="form-label">Hospital Rating</label>
                            <select class="form-select" id="rating" name="rating">
                                <option value="">Select Rating</option>
                                {% for i in range(1, 6) %}
                                <option value="{{ i }}" {% if hospital and hospital.rating == i %}selected{% endif %}>
                                    {{ i }} Star{% if i > 1 %}s{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Overall hospital rating (1-5 stars)</div>
                        </div>
                    </div>

                    <!-- Specializations -->
                    <h5 class="mb-3 text-primary">
                        <i class="fas fa-user-md"></i> Medical Specializations
                    </h5>
                    
                    <div class="mb-3">
                        <label for="specializations" class="form-label">Specializations</label>
                        <input type="text" class="form-control" id="specializations" name="specializations"
                               value="{{ hospital.specializations if hospital and hospital.specializations else '' }}"
                               placeholder="Cardiology, Oncology, Neurology, Orthopedics">
                        <div class="form-text">Separate multiple specializations with commas</div>
                    </div>

                    <!-- Features & Facilities -->
                    <h5 class="mb-3 text-primary">
                        <i class="fas fa-building"></i> Features & Facilities
                    </h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="features" class="form-label">Hospital Features</label>
                            <textarea class="form-control" id="features" name="features" rows="6"
                                      placeholder="24/7 Emergency Care&#10;ICU & Critical Care&#10;Surgery Center&#10;Pharmacy Services&#10;Laboratory Services">{{ hospital.features if hospital and hospital.features else '' }}</textarea>
                            <div class="form-text">
                                <i class="fas fa-info-circle text-primary"></i> 
                                Press Enter for new line. Each feature on a separate line for better display.
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="facilities" class="form-label">Available Facilities</label>
                            <textarea class="form-control" id="facilities" name="facilities" rows="6"
                                      placeholder="Free Parking&#10;24/7 Cafeteria&#10;Free WiFi&#10;Prayer Room&#10;Gift Shop&#10;Patient Library">{{ hospital.facilities if hospital and hospital.facilities else '' }}</textarea>
                            <div class="form-text">
                                <i class="fas fa-info-circle text-primary"></i> 
                                Press Enter for new line. Each facility on a separate line for better display.
                            </div>
                        </div>
                    </div>

                    <!-- Images -->
                    <h5 class="mb-3 text-primary">
                        <i class="fas fa-images"></i> Hospital Images
                    </h5>
                    <div class="mb-3">
                        <label for="images" class="form-label">Upload Images</label>
                        <input type="file" class="form-control" id="images" name="images" multiple accept="image/*">
                        <div class="form-text">Upload multiple images of the hospital. Maximum of 5 images.</div>
                    </div>

                    {% if hospital and hospital_images %}
                    <div class="mb-3">
                        <label class="form-label">Current Images (Drag to reorder)</label>
                        <div id="hospitalImageGallery" class="row g-2">
                            {% for image in hospital_images %}
                            <div class="col-md-3 image-item" data-image-id="{{ image.id }}" data-position="{{ image.position }}">
                                <div class="position-relative">
                                    <img src="{{ image.url }}" alt="Hospital Image" 
                                         class="img-thumbnail" 
                                         style="width: 100%; height: 120px; object-fit: cover; cursor: move;">
                                    
                                    <!-- Delete button -->
                                    <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 delete-image" 
                                            data-image-id="{{ image.id }}"
                                            onclick="deleteHospitalImage('{{ image.id }}')"
                                            style="transform: translate(50%, -50%);">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    
                                    <!-- Primary image radio -->
                                    <div class="position-absolute top-0 start-0 p-1">
                                        <input type="radio" class="form-check-input set-primary" 
                                               name="primary_image" 
                                               value="{{ image.id }}" 
                                               {% if image.is_primary %}checked{% endif %}
                                               title="Set as primary image">
                                    </div>
                                    
                                    <!-- Position number -->
                                    <div class="position-absolute bottom-0 start-0 bg-dark text-white px-2 py-1 small">
                                        <span class="position-number">{{ image.position or loop.index }}</span>
                                    </div>
                                    
                                    {% if image.is_primary %}
                                    <div class="position-absolute bottom-0 end-0 bg-warning text-dark px-2 py-1 small">
                                        <i class="fas fa-star"></i> Primary
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Featured Checkbox -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_featured" id="is_featured" value="true" 
                                   {% if hospital and hospital.is_featured %}checked{% endif %}>
                            <label class="form-check-label" for="is_featured">
                                <i class="fas fa-star text-warning"></i> Featured Hospital
                            </label>
                            <div class="form-text">Featured hospitals will be highlighted and shown prominently.</div>
                        </div>
                    </div>

                    <!-- FAQ Management -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0"><i class="fas fa-question-circle"></i> Frequently Asked Questions</h6>
                        </div>
                        <div class="card-body">
                            <!-- FAQ 1 -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 1 - Question:</label>
                                    <input type="text" class="form-control" name="faq1_question" 
                                           value="{{ hospital.faq1_question or '' }}" placeholder="Enter question 1">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 1 - Answer:</label>
                                    <textarea class="form-control" name="faq1_answer" rows="2" 
                                              placeholder="Enter answer 1">{{ hospital.faq1_answer or '' }}</textarea>
                                </div>
                            </div>
                            
                            <!-- FAQ 2 -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 2 - Question:</label>
                                    <input type="text" class="form-control" name="faq2_question" 
                                           value="{{ hospital.faq2_question or '' }}" placeholder="Enter question 2">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 2 - Answer:</label>
                                    <textarea class="form-control" name="faq2_answer" rows="2" 
                                              placeholder="Enter answer 2">{{ hospital.faq2_answer or '' }}</textarea>
                                </div>
                            </div>
                            
                            <!-- FAQ 3 -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 3 - Question:</label>
                                    <input type="text" class="form-control" name="faq3_question" 
                                           value="{{ hospital.faq3_question or '' }}" placeholder="Enter question 3">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 3 - Answer:</label>
                                    <textarea class="form-control" name="faq3_answer" rows="2" 
                                              placeholder="Enter answer 3">{{ hospital.faq3_answer or '' }}</textarea>
                                </div>
                            </div>
                            
                            <!-- FAQ 4 -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 4 - Question:</label>
                                    <input type="text" class="form-control" name="faq4_question" 
                                           value="{{ hospital.faq4_question or '' }}" placeholder="Enter question 4">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 4 - Answer:</label>
                                    <textarea class="form-control" name="faq4_answer" rows="2" 
                                              placeholder="Enter answer 4">{{ hospital.faq4_answer or '' }}</textarea>
                                </div>
                            </div>
                            
                            <!-- FAQ 5 -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 5 - Question:</label>
                                    <input type="text" class="form-control" name="faq5_question" 
                                           value="{{ hospital.faq5_question or '' }}" placeholder="Enter question 5">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">FAQ 5 - Answer:</label>
                                    <textarea class="form-control" name="faq5_answer" rows="2" 
                                              placeholder="Enter answer 5">{{ hospital.faq5_answer or '' }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="/admin/hospitals" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> {{ action }} Hospital
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Help Section -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="fas fa-info-circle"></i> Help & Guidelines</h6>
            </div>
            <div class="card-body">
                <h6>Required Fields</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-check text-success"></i> Hospital Name</li>
                    <li><i class="fas fa-check text-success"></i> Location</li>
                </ul>

                <h6 class="mt-3">Format Examples</h6>
                <small class="text-muted">
                    <strong>Specializations:</strong><br>
                    Cardiology, Oncology, Neurology<br><br>
                    
                    <strong>Features:</strong><br>
                    24/7 Emergency, ICU, Laboratory<br><br>
                    
                    <strong>Facilities:</strong><br>
                    Parking, Cafeteria, WiFi
                </small>

                <h6 class="mt-3">Tips</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-lightbulb text-warning"></i> Use high-quality images</li>
                    <li><i class="fas fa-lightbulb text-warning"></i> Keep descriptions clear and informative</li>
                    <li><i class="fas fa-lightbulb text-warning"></i> Update contact information regularly</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// Form validation and enhancement
document.addEventListener('DOMContentLoaded', function() {
    // Form submission validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        let isValid = true;
        // Validate required fields
        const requiredFields = ['name', 'location'];
        requiredFields.forEach(fieldName => {
            const field = document.getElementById(fieldName);
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        if (!isValid) {
            e.preventDefault();
            alert('Please correct the errors in the form before submitting.');
        }
    });
    // Add visual feedback for comma-separated fields
    const arrayFields = ['specializations', 'features', 'facilities'];
    arrayFields.forEach(fieldName => {
        const field = document.getElementById(fieldName);
        if (field) {
            field.addEventListener('input', function() {
                // Count items for visual feedback
                const items = this.value.split(',').filter(item => item.trim().length > 0);
                const helpText = this.nextElementSibling;
                if (items.length > 1) {
                    helpText.textContent = `${items.length} items - Separate multiple values with commas`;
                } else if (items.length === 1) {
                    helpText.textContent = `1 item - Separate multiple values with commas`;
                } else {
                    helpText.textContent = `Separate multiple values with commas`;
                }
            });
        }
    });
});

// Hospital image management
function deleteHospitalImage(imageId) {
    console.log('Delete hospital image function called for image ID:', imageId);
    
    if (!confirm('Delete this image?')) return;
    
    const form = document.querySelector('form');
    const formData = new FormData(form);
    formData.append('delete_image_id', imageId);
    
    const targetUrl = window.location.href.replace('/edit', '');
    console.log('Sending hospital image delete request to:', targetUrl);
    
    fetch(targetUrl, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: formData
    })
    .then(response => {
        console.log('Hospital image delete response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Hospital image delete response data:', data);
        if (data.success) {
            location.reload(); // Simple reload to refresh the page
        } else {
            alert('Failed to delete image: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Hospital image delete error:', error);
        alert('Error deleting image: ' + error.message);
    });
}

// Initialize hospital image drag and drop
document.addEventListener('DOMContentLoaded', function() {
    const hospitalImageGallery = document.getElementById('hospitalImageGallery');
    if (!hospitalImageGallery) return;
    
    // Simple drag and drop
    new Sortable(hospitalImageGallery, {
        animation: 150,
        onEnd: function() {
            // Get new order
            const items = hospitalImageGallery.querySelectorAll('.image-item');
            const imageOrder = [];
            
            items.forEach((item, index) => {
                const imageId = item.getAttribute('data-image-id');
                if (imageId) {
                    imageOrder.push({
                        id: parseInt(imageId),
                        position: index + 1
                    });
                }
            });
            
            // Save order
            const form = document.querySelector('form');
            const formData = new FormData(form);
            formData.append('update_image_order', 'true');
            formData.append('image_order', JSON.stringify(imageOrder));
            
            fetch(window.location.href.replace('/edit', ''), {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Reload to show updated positions
                }
            })
            .catch(error => console.error('Error saving hospital image order:', error));
        }
    });

    // Handle primary image selection
    hospitalImageGallery.addEventListener('change', function(e) {
        if (e.target.classList.contains('set-primary')) {
            const imageId = e.target.value;
            const form = document.querySelector('form');
            const formData = new FormData(form);
            formData.append('set_primary_image', imageId);
            
            fetch(window.location.href.replace('/edit', ''), {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Reload to show updated primary image
                } else {
                    alert('Failed to set primary image');
                    e.target.checked = false;
                }
            })
            .catch(error => {
                console.error('Primary image error:', error);
                alert('Error setting primary image');
                e.target.checked = false;
            });
        }
    });
});
</script>

<!-- Add SortableJS for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
{% endblock %}