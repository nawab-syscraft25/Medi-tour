{% extends "base.html" %}

{% block title %}{{ action }} Treatment - Admin Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-procedures"></i> {{ action }} Treatment</h2>
    <a href="/admin/treatments" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Treatments
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Treatment Information</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="/admin/treatments{% if treatment %}/{{ treatment.id }}{% endif %}" enctype="multipart/form-data">
                    <!-- Hidden fields to ensure FAQ arrays are always submitted -->
                    <input type="hidden" name="faq_questions[]" value="">
                    <input type="hidden" name="faq_answers[]" value="">
                    
                    <!-- Basic Information -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Treatment Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   value="{{ treatment.name if treatment else '' }}" required
                                   placeholder="Cardiac Bypass Surgery">
                            <div class="form-text">Full treatment name</div>
                        </div>
                        <div class="col-md-6">
                            <label for="treatment_type" class="form-label">Treatment Type <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <select class="form-select" id="treatment_type" name="treatment_type" required>
                                    <option value="">Select Type</option>
                                    {% for type in treatment_types %}
                                    <option value="{{ type }}" {% if treatment and treatment.treatment_type == type %}selected{% endif %}>{{ type }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-success" onclick="showNewTypeModal()" title="Add New Type">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button type="button" class="btn btn-outline-warning" onclick="showRenameTypeModal()" title="Rename Selected Type" id="renameTypeBtn" disabled>
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="showDeleteTypeModal()" title="Delete Selected Type" id="deleteTypeBtn" disabled>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-info-circle text-primary"></i> 
                                Select a type to rename or delete it. Add new types with the + button.
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="short_description" class="form-label">Short Description <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="short_description" name="short_description" rows="2" required
                                  placeholder="Brief overview of the treatment procedure...">{{ treatment.short_description if treatment else '' }}</textarea>
                        <div class="form-text">Brief summary for listings (max 200 characters)</div>
                    </div>

                    <div class="mb-3">
                        <label for="long_description" class="form-label">Detailed Description</label>
                        <textarea class="form-control" id="long_description" name="long_description" rows="6"
                                  placeholder="Comprehensive description including procedure details, benefits, risks, recovery time...">{{ treatment.long_description if treatment else '' }}</textarea>
                        <div class="form-text">Comprehensive treatment information</div>
                    </div>

                    <!-- Location & Provider -->
                    <h5 class="mb-3 text-primary">
                        <i class="fas fa-map-marker-alt"></i> Location & Provider
                    </h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="location" class="form-label">Location <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="location" name="location" 
                                   value="{{ treatment.location if treatment else '' }}" required
                                   placeholder="City, State, Country">
                            <div class="form-text">Treatment location</div>
                        </div>
                        <div class="col-md-6">
                            <label for="hospital_id" class="form-label">Hospital</label>
                            <select class="form-select" id="hospital_id" name="hospital_id">
                                <option value="">Select Hospital</option>
                                {% for hospital in hospitals %}
                                <option value="{{ hospital.id }}" 
                                        {% if treatment and treatment.hospital_id == hospital.id %}selected{% endif %}>
                                    {{ hospital.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Primary hospital (if applicable)</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="other_hospital_name" class="form-label">Other Hospital Name</label>
                            <input type="text" class="form-control" id="other_hospital_name" name="other_hospital_name" 
                                   value="{{ treatment.other_hospital_name if treatment else '' }}" 
                                   placeholder="Enter hospital name if not in list">
                            <div class="form-text">If hospital not in dropdown list</div>
                        </div>
                        <div class="col-md-6">
                            <label for="doctor_id" class="form-label">Doctor</label>
                            <select class="form-select" id="doctor_id" name="doctor_id">
                                <option value="">Select Doctor</option>
                                {% for doctor in doctors %}
                                <option value="{{ doctor.id }}" 
                                        {% if treatment and treatment.doctor_id == doctor.id %}selected{% endif %}>
                                    {{ doctor.name }} - {{ doctor.designation }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Primary doctor (if applicable)</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="other_doctor_name" class="form-label">Other Doctor Name</label>
                        <input type="text" class="form-control" id="other_doctor_name" name="other_doctor_name" 
                               value="{{ treatment.other_doctor_name if treatment else '' }}" 
                               placeholder="Enter doctor name if not in list">
                        <div class="form-text">If doctor not in dropdown list</div>
                    </div>

                    <!-- Pricing Information -->
                    <h5 class="mb-3 text-primary">
                        <i class="fas fa-dollar-sign"></i> Pricing Information
                    </h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="price_type" id="price_range" value="range" 
                                       {% if treatment and (treatment.price_min or treatment.price_max) %}checked{% endif %}>
                                <label class="form-check-label" for="price_range">
                                    Price Range
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="price_type" id="price_exact_radio" value="exact"
                                       {% if treatment and treatment.price_exact %}checked{% endif %}>
                                <label class="form-check-label" for="price_exact_radio">
                                    Exact Price
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3" id="price_range_fields">
                        <div class="col-md-6">
                            <label for="price_min" class="form-label">Minimum Price ($)</label>
                            <input type="number" class="form-control" id="price_min" name="price_min" 
                                   value="{{ treatment.price_min if treatment else '' }}" min="0" step="0.01"
                                   placeholder="1000.00">
                            <div class="form-text">Starting price range</div>
                        </div>
                        <div class="col-md-6">
                            <label for="price_max" class="form-label">Maximum Price ($)</label>
                            <input type="number" class="form-control" id="price_max" name="price_max" 
                                   value="{{ treatment.price_max if treatment else '' }}" min="0" step="0.01"
                                   placeholder="5000.00">
                            <div class="form-text">Maximum price range</div>
                        </div>
                    </div>

                    <div class="row mb-3" id="price_exact_field">
                        <div class="col-md-6">
                            <label for="price_exact" class="form-label">Exact Price ($)</label>
                            <input type="number" class="form-control" id="price_exact" name="price_exact" 
                                   value="{{ treatment.price_exact if treatment else '' }}" min="0" step="0.01"
                                   placeholder="2500.00">
                            <div class="form-text">Fixed treatment price</div>
                        </div>
                    </div>

                    <!-- Rating -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="rating" class="form-label">Treatment Rating</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="rating" name="rating" 
                                       value="{{ treatment.rating if treatment else '' }}" 
                                       min="1" max="5" step="0.1" 
                                       placeholder="4.5">
                                <span class="input-group-text">
                                    <i class="fas fa-star text-warning"></i>
                                </span>
                            </div>
                            <div class="form-text">Treatment rating from 1.0 to 5.0 stars</div>
                        </div>
                    </div>

                    <!-- Enhanced Images & Media Section -->
                    <h5 class="mb-3 text-primary">
                        <i class="fas fa-images"></i> Treatment Images
                    </h5>
                    
                    <div class="mb-3">
                        <label for="images" class="form-label">Upload Images</label>
                        <input type="file" class="form-control" id="images" name="images" multiple accept="image/*">
                        <div class="form-text">Upload procedure images, before/after photos, equipment images, etc. (Drag to reorder)</div>
                        
                        {% if treatment_images %}
                        <div class="mt-3">
                            <label class="form-label">Current Treatment Images</label>
                            <div id="treatment-images-container" class="row g-2">
                                {% for image in treatment_images %}
                                <div class="col-md-3 image-item" data-image-id="{{ image.id }}" data-position="{{ image.position }}">
                                    <div class="position-relative">
                                        <img src="{{ image.url }}" alt="Treatment Image" 
                                             class="img-thumbnail treatment-image" 
                                             style="width: 100%; height: 120px; object-fit: cover; cursor: move;">
                                        <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 delete-image-btn" 
                                                data-image-type="treatment" data-image-id="{{ image.id }}"
                                                style="transform: translate(50%, -50%);">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        <div class="position-absolute bottom-0 start-0 bg-dark text-white px-2 py-1 small">
                                            {% if image.is_primary %}
                                                <i class="fas fa-star text-warning"></i> Primary
                                            {% endif %}
                                            Position: <span class="position-number">{{ image.position or loop.index }}</span>
                                        </div>
                                        <div class="position-absolute top-0 start-0 bg-primary text-white px-2 py-1 small">
                                            <button type="button" class="btn btn-sm btn-outline-light set-primary-btn" 
                                                    data-image-id="{{ image.id }}" title="Set as Primary">
                                                <i class="fas fa-star"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Featured Treatment -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0"><i class="fas fa-star"></i> Featured Settings</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_featured" id="is_featured" value="true" 
                                       {% if treatment and treatment.is_featured %}checked{% endif %}>
                                <label class="form-check-label" for="is_featured">
                                    <i class="fas fa-star text-warning"></i> Featured Treatment
                                </label>
                                <div class="form-text">Featured treatments will be highlighted and shown prominently on the homepage.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="/admin/treatments" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> {{ action }} Treatment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Help Section -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="fas fa-info-circle"></i> Help & Guidelines</h6>
            </div>
            <div class="card-body">
                <h6>Required Fields</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-check text-success"></i> Treatment Name</li>
                    <li><i class="fas fa-check text-success"></i> Treatment Type</li>
                    <li><i class="fas fa-check text-success"></i> Short Description</li>
                    <li><i class="fas fa-check text-success"></i> Location</li>
                </ul>

                <h6 class="mt-3">Image Management</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-info text-info"></i> Drag images to reorder</li>
                    <li><i class="fas fa-info text-info"></i> Click star to set primary</li>
                    <li><i class="fas fa-info text-info"></i> Click X to delete image</li>
                    <li><i class="fas fa-info text-info"></i> Position numbers update automatically</li>
                </ul>

                <h6 class="mt-3">Content Tips</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-lightbulb text-warning"></i> Use clear, medical terminology</li>
                    <li><i class="fas fa-lightbulb text-warning"></i> Include benefits and risks</li>
                    <li><i class="fas fa-lightbulb text-warning"></i> Mention recovery time</li>
                    <li><i class="fas fa-lightbulb text-warning"></i> Add pre/post procedure care</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// Enhanced form validation and image management
document.addEventListener('DOMContentLoaded', function() {
    // Price type toggle
    const priceRangeRadio = document.getElementById('price_range');
    const priceExactRadio = document.getElementById('price_exact_radio');
    const priceRangeFields = document.getElementById('price_range_fields');
    const priceExactField = document.getElementById('price_exact_field');

    function togglePriceFields() {
        if (priceRangeRadio.checked) {
            priceRangeFields.style.display = 'flex';
            priceExactField.style.display = 'none';
            document.getElementById('price_exact').value = '';
        } else if (priceExactRadio.checked) {
            priceRangeFields.style.display = 'none';
            priceExactField.style.display = 'flex';
            document.getElementById('price_min').value = '';
            document.getElementById('price_max').value = '';
        }
    }

    priceRangeRadio.addEventListener('change', togglePriceFields);
    priceExactRadio.addEventListener('change', togglePriceFields);
    togglePriceFields();

    // Character count for short description
    const shortDescInput = document.getElementById('short_description');
    shortDescInput.addEventListener('input', function() {
        const length = this.value.length;
        const helpText = this.nextElementSibling;
        helpText.textContent = `${length}/200 characters - Brief summary for listings`;
        
        if (length > 200) {
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
        }
    });

    // Image deletion functionality
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-image-btn')) {
            const btn = e.target.closest('.delete-image-btn');
            const imageType = btn.getAttribute('data-image-type');
            
            if (confirm('Are you sure you want to delete this image?')) {
                if (imageType === 'treatment') {
                    const imageId = btn.getAttribute('data-image-id');
                    const imageItem = btn.closest('.image-item');
                    imageItem.remove();
                    addHiddenInput('delete_image_ids[]', imageId);
                    updatePositionNumbers();
                }
            }
        }

        // Set primary image functionality
        if (e.target.closest('.set-primary-btn')) {
            const btn = e.target.closest('.set-primary-btn');
            const imageId = btn.getAttribute('data-image-id');
            
            // Remove primary status from all images
            document.querySelectorAll('.image-item').forEach(item => {
                const primaryIndicator = item.querySelector('.bg-dark .fa-star');
                if (primaryIndicator) {
                    primaryIndicator.parentElement.innerHTML = primaryIndicator.parentElement.innerHTML.replace('<i class="fas fa-star text-warning"></i> Primary', '');
                }
            });
            
            // Add primary status to clicked image
            const clickedItem = btn.closest('.image-item');
            const positionDiv = clickedItem.querySelector('.bg-dark');
            positionDiv.innerHTML = '<i class="fas fa-star text-warning"></i> Primary Position: <span class="position-number">' + 
                                   clickedItem.getAttribute('data-position') + '</span>';
            
            // Add hidden input for primary image
            addHiddenInput('primary_image_id', imageId);
        }
    });

    // Drag and drop functionality for treatment images
    const container = document.getElementById('treatment-images-container');
    if (container) {
        let draggedElement = null;

        container.addEventListener('dragstart', function(e) {
            if (e.target.closest('.image-item')) {
                draggedElement = e.target.closest('.image-item');
                draggedElement.style.opacity = '0.5';
            }
        });

        container.addEventListener('dragend', function(e) {
            if (draggedElement) {
                draggedElement.style.opacity = '1';
                draggedElement = null;
                updatePositionNumbers();
            }
        });

        container.addEventListener('dragover', function(e) {
            e.preventDefault();
        });

        container.addEventListener('drop', function(e) {
            e.preventDefault();
            const dropTarget = e.target.closest('.image-item');
            
            if (dropTarget && draggedElement && dropTarget !== draggedElement) {
                const rect = dropTarget.getBoundingClientRect();
                const midpoint = rect.left + rect.width / 2;
                
                if (e.clientX < midpoint) {
                    container.insertBefore(draggedElement, dropTarget);
                } else {
                    container.insertBefore(draggedElement, dropTarget.nextSibling);
                }
                updatePositionNumbers();
            }
        });

        // Make images draggable
        container.querySelectorAll('.image-item').forEach(item => {
            item.setAttribute('draggable', 'true');
        });
    }

    // Helper functions
    function addHiddenInput(name, value) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        document.querySelector('form').appendChild(input);
    }

    function updatePositionNumbers() {
        const container = document.getElementById('treatment-images-container');
        if (container) {
            const items = container.querySelectorAll('.image-item');
            items.forEach((item, index) => {
                const positionSpan = item.querySelector('.position-number');
                if (positionSpan) {
                    positionSpan.textContent = index + 1;
                }
                item.setAttribute('data-position', index + 1);
                
                const imageId = item.getAttribute('data-image-id');
                addHiddenInput('image_positions[' + imageId + ']', index + 1);
            });
        }
    }
});
</script>

<!-- Add SortableJS for better drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('treatment-images-container');
    if (container && typeof Sortable !== 'undefined') {
        new Sortable(container, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onEnd: function(evt) {
                updatePositionNumbers();
            }
        });
    }
});
</script>

<style>
.sortable-ghost {
    opacity: 0.4;
}

.sortable-chosen {
    transform: scale(1.05);
}

.image-item {
    transition: transform 0.2s ease;
}

.image-item:hover {
    transform: scale(1.02);
}

.delete-image-btn, .set-primary-btn {
    z-index: 10;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.delete-image-btn:hover {
    background-color: #dc3545 !important;
    transform: translate(50%, -50%) scale(1.1);
}

.set-primary-btn:hover {
    background-color: #0d6efd !important;
    transform: scale(1.1);
}
</style>
{% endblock %}
